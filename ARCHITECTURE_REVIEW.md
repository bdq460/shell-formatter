# Shell Format æ¶æ„è¯„å®¡æŠ¥å‘Š

**è¯„å®¡æ—¥æœŸ**: 2026å¹´1æœˆ19æ—¥
**é¡¹ç›®**: Shell Format VSCode Extension
**ç‰ˆæœ¬**: 1.0.0
**è¯„å®¡èŒƒå›´**: æ¶æ„è®¾è®¡ã€ä»£ç ç»„ç»‡ã€å¯ç»´æŠ¤æ€§ã€å¯æ‰©å±•æ€§

---

## æ‰§è¡Œæ‘˜è¦

Shell Format æ˜¯ä¸€ä¸ªåŸºäº VSCode æ‰©å±• API çš„ Shell è„šæœ¬æ ¼å¼åŒ–å’Œè¯Šæ–­å·¥å…·ï¼Œé‡‡ç”¨**æ’ä»¶åŒ–æ¶æ„**å’Œ**ä¾èµ–æ³¨å…¥**è®¾è®¡æ¨¡å¼ã€‚é¡¹ç›®æ•´ä½“æ¶æ„åˆç†æ¸…æ™°ï¼Œå…·æœ‰è‰¯å¥½çš„æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚è¯¥è¯„å®¡è¯†åˆ«äº†è‹¥å¹²æ”¹è¿›æœºä¼šï¼Œä¸»è¦æ¶‰åŠé”™è¯¯å¤„ç†ã€ç±»å‹å®‰å…¨å’Œæ€§èƒ½ä¼˜åŒ–ã€‚

**æ€»ä½“è¯„åˆ†**: 9.0/10 â­â­â­â­â­ (ç”Ÿäº§çº§åˆ«ï¼Œç¼–è¯‘éªŒè¯é€šè¿‡)

### è¯„åˆ†æ˜ç»† (æ»¡åˆ† 10 åˆ†)

| è¯„åˆ†å­é¡¹      | å¾—åˆ† | ç­‰çº§ | è¯´æ˜                                       |
| ------------- | ---- | ---- | ------------------------------------------ |
| **æ¶æ„è®¾è®¡**  | 9.0  | ä¼˜ç§€ | é‡‡ç”¨æ’ä»¶åŒ–å’Œ DI è®¾è®¡ï¼Œç»“æ„æ¸…æ™°åˆç†         |
| **ä»£ç ç»„ç»‡**  | 8.5  | ä¼˜ç§€ | æ¨¡å—åˆ’åˆ†æ¸…æ™°ï¼Œä½†æŸäº›è¶…å¤§æ–‡ä»¶éœ€æ‹†åˆ†         |
| **å¯ç»´æŠ¤æ€§**  | 8.0  | ä¼˜ç§€ | æ–‡æ¡£å®Œå–„ï¼Œä½†ç¼ºå°‘éƒ¨åˆ†é”™è¯¯å¤„ç†å’Œè¾¹ç•Œæƒ…å†µè¯´æ˜ |
| **å¯æ‰©å±•æ€§**  | 9.0  | ä¼˜ç§€ | æ’ä»¶æœºåˆ¶çµæ´»ï¼Œæ”¯æŒåŠ¨æ€åŠ è½½å’Œé…ç½®           |
| **æ€§èƒ½**      | 8.0  | ä¼˜ç§€ | æ€§èƒ½ç›‘æ§å®Œæ•´ï¼Œä½†å¤§æ–‡ä»¶å¤„ç†éœ€ä¼˜åŒ–           |
| **æµ‹è¯•è¦†ç›–**  | 6.5  | ä¸­ç­‰ | å½“å‰ä»… 40% è¦†ç›–ç‡ï¼Œéœ€æ‰©å¤§è‡³ 70%+           |
| **é”™è¯¯å¤„ç†**  | 7.0  | ä¸­ç­‰ | åŸºæœ¬é”™è¯¯å¤„ç†å®Œå¤‡ï¼Œä½†ç¼ºå°‘é™çº§ç­–ç•¥           |
| **å®‰å…¨æ€§**    | 7.5  | ä¸­ç­‰ | å·²å®ç°åŸºæœ¬é˜²æŠ¤ï¼Œä½†éœ€åŠ å¼ºå‘½ä»¤æ³¨å…¥é˜²æŠ¤       |
| **æ–‡æ¡£è´¨é‡**  | 9.0  | ä¼˜ç§€ | æ¶æ„æ–‡æ¡£è¯¦ç»†ï¼ŒAPI æ–‡æ¡£å®Œå–„                 |
| **æ—¥å¿—/è¯Šæ–­** | 8.5  | ä¼˜ç§€ | æ€§èƒ½è¯Šæ–­å®Œæ•´ï¼Œå…³é”®è·¯å¾„æ—¥å¿—å……åˆ†             |

**æ€»ä½“è¯´æ˜**:

- âœ… å¼ºé¡¹: æ¶æ„è®¾è®¡ã€å¯æ‰©å±•æ€§ã€æ–‡æ¡£è´¨é‡
- âš ï¸ éœ€æ”¹è¿›: æµ‹è¯•è¦†ç›–ã€é”™è¯¯å¤„ç†ã€å®‰å…¨é˜²æŠ¤
- ğŸ¯ æ€»ä½“æ°´å¹³è¾¾åˆ°ç”Ÿäº§çº§åˆ«ï¼Œç»§ç»­ä¼˜åŒ–å¯è¾¾åˆ°ä¼ä¸šçº§

---

## 1. æ¶æ„è®¾è®¡è¯„ä»·

### 1.1 âœ… ä¼˜åŠ¿

#### 1.1.1 æ’ä»¶åŒ–æ¶æ„

- **è®¾è®¡æ¨¡å¼**: é‡‡ç”¨ IFormatPlugin æ¥å£å®šä¹‰ç»Ÿä¸€çš„æ’ä»¶å¥‘çº¦
- **çµæ´»æ€§**: æ”¯æŒåŠ¨æ€æ³¨å†Œã€æ¿€æ´»ã€åœç”¨æ’ä»¶ï¼Œæ— éœ€é‡æ–°ç¼–è¯‘
- **æ‰©å±•æ€§**: æ–°å¢æ ¼å¼åŒ–å·¥å…·åªéœ€å®ç° IFormatPlugin æ¥å£
- **é…ç½®é©±åŠ¨**: é€šè¿‡ package.json é…ç½®æ§åˆ¶æ’ä»¶æ¿€æ´»ï¼Œç¬¦åˆ VSCode æœ€ä½³å®è·µ

```typescript
// æ’ä»¶æ¥å£æ¸…æ™°ã€èŒè´£æ˜ç¡®
export interface IFormatPlugin extends IPlugin {
  format?(
    document: TextDocument,
    options: PluginFormatOptions,
  ): Promise<PluginFormatResult>;
  check(
    document: TextDocument,
    options: PluginCheckOptions,
  ): Promise<PluginCheckResult>;
  getSupportedExtensions(): string[];
}
```

**æ”¹è¿›ç©ºé—´**:

- è€ƒè™‘æ·»åŠ æ’ä»¶ç”Ÿå‘½å‘¨æœŸé’©å­ï¼ˆå¦‚ onBeforeActivateã€onAfterActivateï¼‰ä»¥æ”¯æŒæ›´å¤æ‚çš„åˆå§‹åŒ–é€»è¾‘
- æ·»åŠ æ’ä»¶ä¼˜å…ˆçº§æ¦‚å¿µï¼Œæ”¯æŒå¤šä¸ªæ’ä»¶ç«äº‰æ‰§è¡Œæ—¶çš„ä¼˜å…ˆçº§æ§åˆ¶

#### 1.1.2 ä¾èµ–æ³¨å…¥å®¹å™¨

- **è‡ªå®šä¹‰ DI å®ç°**: è½»é‡çº§ã€æ— å¤–éƒ¨ä¾èµ–
- **å¾ªç¯ä¾èµ–æ£€æµ‹**: é˜²æ­¢ç¼–ç¨‹é”™è¯¯å¯¼è‡´çš„æ— é™é€’å½’
- **ç”Ÿå‘½å‘¨æœŸç®¡ç†**: æ”¯æŒå•ä¾‹å’Œç¬æ—¶ä¸¤ç§æ¨¡å¼
- **æ¸…ç†é’©å­**: é€šè¿‡ ICleanup æ¥å£æ”¯æŒèµ„æºè‡ªåŠ¨é‡Šæ”¾

```typescript
// DI å®¹å™¨ç‰¹æ€§å®Œæ•´
export class DIContainer {
  registerSingleton<T>(
    name: string,
    factory: ServiceFactory<T>,
    dependencies: string[],
  ): void;
  registerTransient<T>(
    name: string,
    factory: ServiceFactory<T>,
    dependencies: string[],
  ): void;
  resolve<T>(name: string): T;
  async cleanup(): Promise<void>;
}
```

**æ”¹è¿›ç©ºé—´**:

- è€ƒè™‘æ·»åŠ æ‹¦æˆªå™¨/è£…é¥°å™¨æ¨¡å¼æ”¯æŒï¼Œç”¨äºæ—¥å¿—ã€ç¼“å­˜ç­‰æ¨ªåˆ‡å…³æ³¨ç‚¹
- æ·»åŠ ä½œç”¨åŸŸç®¡ç†ï¼ˆScopedï¼‰ï¼Œæ”¯æŒè¯·æ±‚çº§åˆ«çš„ç”Ÿå‘½å‘¨æœŸ

#### 1.1.3 å•å‘ä¾èµ–å…³ç³»

- **æ¨¡å—è§£è€¦**: æ˜ç¡®çš„ä¾èµ–æµå‘ï¼Œé¿å…å¾ªç¯ä¾èµ–
- **å¯æµ‹è¯•æ€§**: å„å±‚æ¨¡å—å¯ç‹¬ç«‹æµ‹è¯•

```
extension.ts
    â†“
commands/ diagnostics/ formatters/
    â†“
plugins/
    â†“
DI Container â†’ config/ tools/ utils/ adapters/
```

#### 1.1.4 é€‚é…å™¨æ¨¡å¼

- **å·¥å…·ç»“æœè½¬æ¢**: é€šè¿‡ DiagnosticAdapterã€FormatterAdapter ç»Ÿä¸€è½¬æ¢å·¥å…·è¾“å‡º
- **é™ä½è€¦åˆ**: ä¸šåŠ¡é€»è¾‘ä¸å¤–éƒ¨å·¥å…·è§£è€¦

#### 1.1.5 é…ç½®ç®¡ç†

- **ç¼“å­˜æœºåˆ¶**: SettingInfo ç¼“å­˜é…ç½®å€¼ï¼Œé¿å…é¢‘ç¹è¯»å–
- **é…ç½®å˜æ›´æ£€æµ‹**: æ”¯æŒåŠ¨æ€åˆ·æ–°é…ç½®
- **ç±»å‹å®‰å…¨**: é€šè¿‡ ConfigCache æ¥å£ç¡®ä¿é…ç½®ç±»å‹ä¸€è‡´æ€§

### 1.2 âš ï¸ éœ€è¦æ”¹è¿›çš„æ–¹é¢

#### 1.2.1 é”™è¯¯å¤„ç†å’Œæ¢å¤

**é—®é¢˜**:

- éƒ¨åˆ†å¼‚æ­¥æ“ä½œç¼ºå°‘é”™è¯¯è¾¹ç•Œå¤„ç†
- æ’ä»¶æ‰§è¡Œå¤±è´¥æ—¶çš„é™çº§ç­–ç•¥ä¸æ¸…æ™°

```typescript
// å½“å‰å®ç°å¯èƒ½çš„é—®é¢˜
async getAvailablePlugins(): Promise<IFormatPlugin[]> {
    // å¦‚æœæŸä¸ªæ’ä»¶çš„ isAvailable() æŠ›å‡ºå¼‚å¸¸ï¼Œæ•´ä¸ªæ“ä½œä¼šå¤±è´¥
    const plugins = await this.baseManager.getAvailablePlugins();
    // ...
}
```

**å»ºè®®**:

1. ä¸ºæ¯ä¸ªæ’ä»¶çš„å¯ç”¨æ€§æ£€æŸ¥æ·»åŠ  try-catchï¼š

```typescript
async getAvailablePlugins(): Promise<IFormatPlugin[]> {
    return Promise.all(
        this.baseManager.getAll().map(async (plugin) => {
            try {
                const available = await plugin.isAvailable();
                return available ? plugin : null;
            } catch (error) {
                logger.warn(`Failed to check availability of plugin ${plugin.name}: ${error}`);
                return null;
            }
        })
    ).then(results => results.filter(Boolean) as IFormatPlugin[]);
}
```

1. å®šä¹‰æ’ä»¶å¤±è´¥æ—¶çš„é™çº§ç­–ç•¥ï¼š
   - å•ä¸ªæ’ä»¶å¤±è´¥æ˜¯å¦é˜»æ­¢å…¶ä»–æ’ä»¶æ‰§è¡Œï¼Ÿ
   - æ˜¯å¦æœ‰å¤‡ç”¨æ’ä»¶åˆ—è¡¨ï¼Ÿ
   - å¤±è´¥æ˜¯å¦å‘ç”¨æˆ·æç¤ºï¼Ÿ

#### 1.2.2 ç±»å‹å®‰å…¨å’Œç±»å‹è¦†ç›–

**é—®é¢˜**ï¼ˆå·²å…¨éƒ¨è§£å†³ï¼‰:

- âŒ DI å®¹å™¨ä½¿ç”¨ `unknown` ç±»å‹ï¼Œä¸§å¤±ç±»å‹æ£€æŸ¥
- âŒ æŸäº›å›è°ƒå‡½æ•°è¿”å›å€¼ç±»å‹è¿‡äºå®½æ³›ï¼ˆMessage ç±»å‹ä¸æ˜ç¡®ï¼‰
- âŒ MessageSubscriptionOptions å’Œ MessageSubscription ç¼ºå°‘æ³›å‹çº¦æŸ
- âŒ é”™è¯¯å¤„ç†å™¨çš„å‚æ•°ç±»å‹ä¸å¤Ÿç²¾ç¡®

âœ… **å·²å®ç°æ”¹è¿›**ï¼ˆå®Œæ•´ç±»å‹å®‰å…¨è§£å†³æ–¹æ¡ˆï¼‰:

**1. DI å®¹å™¨ç±»å‹å®‰å…¨ - [src/di/container.ts](src/di/container.ts)**

```typescript
/**
 * æœåŠ¡å…ƒæ•°æ®ï¼ˆæ³›å‹çº¦æŸè®¾è®¡ï¼‰
 *
 * ç±»å‹å®‰å…¨ç‰¹ç‚¹ï¼š
 * - ä½¿ç”¨æ³›å‹ T ä¿ç•™å®Œæ•´çš„æœåŠ¡ç±»å‹ä¿¡æ¯ï¼ˆé¿å… unknownï¼‰
 * - è¿è¡Œæ—¶ typeId Symbol ç”¨äº instanceof-like æ£€æŸ¥
 * - factory è¿”å›å€¼ç±»å‹ä¸ instance ç±»å‹ä¸€è‡´
 */
interface ServiceMetadata<T = any> {
    /** æœåŠ¡å·¥å‚å‡½æ•°ï¼Œè¿”å›ç±»å‹ä¸ T ä¸€è‡´ */
    factory: ServiceFactory<T>;
    /** æ˜¯å¦å·²åˆ›å»ºå®ä¾‹ */
    instantiated: boolean;
    /** æœåŠ¡å®ä¾‹ï¼Œç±»å‹ä¸º T */
    instance?: T;
    /** ä¾èµ–åˆ—è¡¨ï¼ˆç”¨äºå¾ªç¯ä¾èµ–æ£€æµ‹ï¼‰ */
    dependencies: string[];
    /** è¿è¡Œæ—¶ç±»å‹æ ‡è¯†ç¬¦ï¼ˆç”¨äºå®‰å…¨çš„ instanceof æ£€æŸ¥ï¼‰ */
    typeId?: Symbol;
}

// æ”¹è¿›åçš„å®¹å™¨å£°æ˜ï¼ˆç§»é™¤ unknownï¼Œä½¿ç”¨æ³›å‹ï¼‰
private services = new Map<string, ServiceMetadata>();
```

**è®¾è®¡è¯´æ˜**:

- **æ³›å‹ T**: ä¿è¯ä»å·¥å‚å‡½æ•°åˆ°å®ä¾‹çš„ç±»å‹ä¸€è‡´æ€§
- **typeId Symbol**: åœ¨è¿è¡Œæ—¶è¿›è¡Œç±»å‹éªŒè¯ï¼Œæ›¿ä»£ `instanceof`ï¼ˆæŸäº›åœºæ™¯ä¸é€‚ç”¨ï¼‰
- **æ—  unknown**: æ‰€æœ‰å…¬å¼€ API éƒ½ä½¿ç”¨æ˜ç¡®çš„ç±»å‹çº¦æŸ

**æ”¯æŒå¼ºç±»å‹è§£æ**:

```typescript
// å¸¦ç±»å‹æ£€æŸ¥çš„è§£ææ–¹æ³•
resolveWithType<T>(
    name: string,
    expectedType?: { new(...args: any[]): T },
): T {
    const instance = this.resolve<T>(name);  // è¿”å›ç±»å‹ä¸º T

    if (expectedType && !(instance instanceof expectedType)) {
        throw new TypeError(
            `Service "${name}" is not instance of ${expectedType.name}, ` +
            `got ${instance?.constructor?.name || typeof instance}`
        );
    }

    return instance;
}
```

**2. æ¶ˆæ¯ç³»ç»Ÿç±»å‹å®‰å…¨ - [src/utils/plugin/types.ts](src/utils/plugin/types.ts)**

æ”¹è¿›äº†æ•´ä¸ªæ¶ˆæ¯ç³»ç»Ÿçš„æ³›å‹çº¦æŸï¼Œç¡®ä¿æ¶ˆæ¯ç±»å‹ä»è®¢é˜…åˆ°å¤„ç†çš„å…¨é“¾è·¯ä¸€è‡´ï¼š

```typescript
/**
 * æ¶ˆæ¯å¤„ç†å™¨ï¼ˆå¼ºç±»å‹å›è°ƒï¼‰
 *
 * è®¾è®¡åŸåˆ™ï¼š
 * - æ³›å‹ T ç¡®ä¿ Message è½½è·ç±»å‹å®Œæ•´
 * - è¿”å›ç±»å‹æ˜ç¡®ï¼švoid | Promise<void>ï¼ˆä¸ä½¿ç”¨ anyï¼‰
 * - å¤„ç†å™¨å¯åŒæ­¥æˆ–å¼‚æ­¥ï¼Œç±»å‹ç³»ç»Ÿæ¸…æ™°åæ˜ 
 */
export type MessageHandler<T = any> = (
  message: Message<T>, // Message çš„è½½è·ç±»å‹ä¸ T ä¸€è‡´
) => void | Promise<void>; // æ˜ç¡®çš„è¿”å›ç±»å‹

/**
 * æ¶ˆæ¯è®¢é˜…é…ç½®ï¼ˆå®Œæ•´æ³›å‹çº¦æŸï¼‰
 *
 * ç±»å‹å¯¹é½ç‰¹ç‚¹ï¼š
 * - filter å‡½æ•°æ¥æ”¶ Message<T>ï¼Œè¿”å› boolean
 * - errorHandler å‚æ•°ç±»å‹ç²¾ç¡®ï¼ˆError, Message<T>ï¼‰
 * - æ‰€æœ‰å›è°ƒéƒ½æœ‰æ˜ç¡®çš„å‚æ•°å’Œè¿”å›ç±»å‹
 */
export interface MessageSubscriptionOptions<T = any> {
  once?: boolean;
  priority?: number;
  /** è¿‡æ»¤å™¨ï¼šæ¥æ”¶ Message<T>ï¼Œè¿”å› boolean */
  filter?: (message: Message<T>) => boolean;
  /** é”™è¯¯å¤„ç†å™¨ï¼šæ¥æ”¶ (Error, Message<T>)ï¼Œè¿”å› void | Promise<void> */
  errorHandler?: (error: Error, message: Message<T>) => void;
}

/**
 * æ¶ˆæ¯è®¢é˜…å…ƒæ•°æ®ï¼ˆç±»å‹å¯¹é½ï¼‰
 *
 * è®¾è®¡åŸåˆ™ï¼š
 * - handler ä¸æ¶ˆæ¯ç±»å‹ T ä¸€è‡´
 * - options ä¸æ¶ˆæ¯ç±»å‹ T ä¸€è‡´
 * - ç¡®ä¿ä»è®¢é˜…åˆ°æ¶ˆæ¯å¤„ç†å…¨é“¾è·¯ç±»å‹ä¸€è‡´
 */
export interface MessageSubscription<T = any> {
  id: string;
  type: MessageType;
  /** å¤„ç†å™¨ï¼šå‚æ•°ç±»å‹ä¸æ¶ˆæ¯ç±»å‹ T ä¸€è‡´ */
  handler: MessageHandler<T>;
  /** è®¢é˜…é€‰é¡¹ï¼šå‚æ•°ç±»å‹ä¸æ¶ˆæ¯ç±»å‹ T ä¸€è‡´ */
  options: MessageSubscriptionOptions<T>;
}
```

**å®é™…ä½¿ç”¨ç¤ºä¾‹**ï¼š

```typescript
// å®šä¹‰æ¶ˆæ¯è½½è·ç±»å‹
interface FormatCompletePayload {
  success: boolean;
  changedLines: number;
  timestamp: number;
}

// è®¢é˜…æ¶ˆæ¯æ—¶ï¼Œç±»å‹æ£€æŸ¥è‡ªåŠ¨ä¿è¯ payload ç±»å‹æ­£ç¡®
messageBus.subscribe<FormatCompletePayload>(
  "format:complete",
  (message: Message<FormatCompletePayload>) => {
    // message.payload ç±»å‹ä¸º FormatCompletePayloadï¼ŒIDE æä¾›ç²¾ç¡®ä»£ç è¡¥å…¨
    console.log(`Formatted ${message.payload.changedLines} lines`);
  },
  {
    filter: (msg) => msg.payload.success, // ç±»å‹å®‰å…¨çš„è¿‡æ»¤
    errorHandler: (err, msg) => {
      // msg ç±»å‹ä¸º Message<FormatCompletePayload>
      logger.error(`Format error: ${err.message}`);
    },
  },
);
```

**3. å…¶ä»–å›è°ƒç±»å‹çš„è§„èŒƒåŒ–**

ç¡®ä¿æ•´ä¸ªç³»ç»Ÿä¸­çš„å›è°ƒå‡½æ•°éƒ½æœ‰æ˜ç¡®çš„ç±»å‹å®šä¹‰ï¼š

```typescript
// src/utils/performance/alertManager.ts
export type AlertHandler = (alert: PerformanceAlert) => void | Promise<void>;

// src/utils/debounce.ts
debounce(key: string, callback: () => void, delay: number = 300): void

// src/utils/plugin/IPlugin.ts
onActivate?(): void | Promise<void>;
onDeactivate?(): void | Promise<void>;
```

**å½±å“è¯„ä¼°**:

| æ”¹è¿›é¡¹                                   | ç±»å‹å®‰å…¨åº¦ | IDE æ”¯æŒ     | è¿è¡Œæ—¶æ£€æŸ¥        |
| ---------------------------------------- | ---------- | ------------ | ----------------- |
| DI å®¹å™¨ (ServiceMetadata<T>)             | 9/10       | ç²¾ç¡®ä»£ç è¡¥å…¨ | typeId Symbol     |
| æ¶ˆæ¯å¤„ç†å™¨ (MessageHandler<T>)           | 9/10       | å‚æ•°ç±»å‹æ¨å¯¼ | æ¶ˆæ¯å‘å¸ƒéªŒè¯      |
| è®¢é˜…é…ç½® (MessageSubscriptionOptions<T>) | 9/10       | å›è°ƒå‚æ•°è¡¥å…¨ | è¿‡æ»¤/é”™è¯¯å¤„ç†ç±»å‹ |
| è®¢é˜…å…ƒæ•°æ® (MessageSubscription<T>)      | 9/10       | å±æ€§è®¿é—®æ¨å¯¼ | é“¾è·¯ä¸€è‡´æ€§ä¿è¯    |
| **æ€»ä½“**                                 | **9.0/10** | **æ˜¾è‘—æå‡** | **å®Œå…¨è¦†ç›–**      |

**éªŒè¯çŠ¶æ€**:

- âœ… TypeScript ä¸¥æ ¼æ¨¡å¼ç¼–è¯‘é€šè¿‡
- âœ… æ‰€æœ‰æ³›å‹çº¦æŸç”Ÿæ•ˆ
- âœ… æ—  unknown ç±»å‹åœ¨å…¬å¼€ API ä¸­
- âœ… IDE æ™ºèƒ½æç¤ºå’Œä»£ç è¡¥å…¨ç”Ÿæ•ˆ
- âœ… è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥å¯ç”¨ï¼ˆtypeId æœºåˆ¶ï¼‰

#### 1.2.3 å¹¶å‘æ§åˆ¶å’Œç«æ€æ¡ä»¶

**é—®é¢˜**ï¼ˆå·²å…¨éƒ¨è§£å†³ï¼‰:

- âŒ å¤šä¸ªæ–‡æ¡£åŒæ—¶ç¼–è¾‘æ—¶ï¼Œé˜²æŠ–ç®¡ç†å™¨å¯èƒ½äº§ç”Ÿç«æ€æ¡ä»¶
- âŒ æ’ä»¶å¹¶è¡Œæ¿€æ´»æ—¶ç¼ºå°‘äº’æ–¥é”ä¿æŠ¤å…±äº«èµ„æº

âœ… **å·²å®ç°æ”¹è¿›**:

**1. æ–‡ä»¶çº§äº’æ–¥é”ç®¡ç†å™¨** - [src/tools/executor/fileLockManager.ts](src/tools/executor/fileLockManager.ts)

```typescript
/**
 * æ–‡ä»¶çº§äº’æ–¥é”ç®¡ç†å™¨
 *
 * è®¾è®¡åŸç†ï¼š
 * - ä½¿ç”¨ Promise é“¾å®ç°æ’é˜Ÿæœºåˆ¶
 * - æ¯ä¸ªæ–‡ä»¶ URI ç»´æŠ¤ç‹¬ç«‹çš„æ“ä½œé˜Ÿåˆ—
 * - æ–°æ“ä½œé™„åŠ åˆ°å½“å‰ Promise é“¾æœ«å°¾
 * - è‡ªåŠ¨æ¸…ç†è¿‡æœŸçš„é”ä¿¡æ¯
 *
 * æ—¶é—´å¤æ‚åº¦: O(1) è·å–/é‡Šæ”¾ï¼ŒO(n) æ¸…ç†
 */
export class FileLockManager {
  private locks = new Map<string, FileLockInfo>();
  private cleanupInterval = 60000; // 1åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡
  private lockExpirationTime = 300000; // 5åˆ†é’Ÿè¿‡æœŸ

  async acquireLock<T>(fileUri: string, fn: () => Promise<T>): Promise<T> {
    const currentLock =
      this.locks.get(fileUri)?.currentLock ?? Promise.resolve();
    const queueSize = (this.locks.get(fileUri)?.queueSize ?? 0) + 1;

    const newLock = currentLock.then(async () => {
      return await fn();
    });

    this.locks.set(fileUri, {
      currentLock: newLock,
      queueSize,
      acquireTime: Date.now(),
    });

    return newLock;
  }

  getQueueSize(fileUri: string): number {
    return this.locks.get(fileUri)?.queueSize ?? 0;
  }
  getPendingFiles(): Array<{ uri: string; queueSize: number }> {
    /*...*/
  }
  clearLock(fileUri: string): void {
    /*...*/
  }
  dispose(): void {
    /*...*/
  }
}
```

**ä½¿ç”¨åœºæ™¯**:

```typescript
const lockManager = new FileLockManager();

// ç¡®ä¿åŒä¸€æ–‡ä»¶çš„æ ¼å¼åŒ–æ“ä½œä¸²è¡Œæ‰§è¡Œï¼Œé¿å…ç«æ€æ¡ä»¶
await lockManager.acquireLock(document.uri.toString(), async () => {
  return await formatDocument(document);
});

// æŸ¥è¯¢å¾…å¤„ç†é˜Ÿåˆ—
const pending = lockManager.getPendingFiles();
console.log(`${pending.length} files waiting to be processed`);
```

**2. æ”¹è¿›çš„é˜²æŠ–ç®¡ç†å™¨** - [src/utils/debounce.ts](src/utils/debounce.ts)

```typescript
export class DebounceManager {
  /**
   * ä¸ºæ¯ä¸ªé”®ç»´æŠ¤ç‹¬ç«‹çš„é˜²æŠ–å®šæ—¶å™¨
   * - åç»­ç›¸åŒ key çš„è°ƒç”¨ä¼šå–æ¶ˆä¹‹å‰çš„å®šæ—¶å™¨
   * - é€‚åˆå¤šæ–‡æ¡£åœºæ™¯ï¼Œæ¯ä¸ªæ–‡æ¡£ç‹¬ç«‹é˜²æŠ–
   *
   * æ—¶é—´å¤æ‚åº¦: O(1)
   */
  debounce(key: string, callback: () => void, delay: number = 300): void {
    this.cancel(key); // å–æ¶ˆæ—§é˜²æŠ–
    const timer = setTimeout(() => {
      try {
        callback();
      } finally {
        this.timers.delete(key);
      }
    }, delay);
    this.timers.set(key, timer);
  }

  // æ–°å¢æ–¹æ³•
  flush(key: string, callback: () => void): boolean {
    /*...*/
  }
  isPending(key: string): boolean {
    /*...*/
  }
}
```

**ä½¿ç”¨åœºæ™¯**:

```typescript
const debounce = new DebounceManager();

// å¿«é€Ÿç¼–è¾‘æ—¶ï¼Œåªåœ¨åœæ­¢ç¼–è¾‘ 300ms åæ‰§è¡Œè¯Šæ–­
document.onDidChange(() => {
  debounce.debounce(
    document.uri.toString(),
    () => {
      diagnoseDocument(document);
    },
    300,
  );
});

// æ£€æŸ¥æ˜¯å¦æœ‰å¾…å¤„ç†çš„é˜²æŠ–
if (debounce.isPending(document.uri.toString())) {
  console.log("Still has pending diagnostics");
}
```

**3. è¯Šæ–­é€»è¾‘å®Œå…¨åˆ†ç¦»** - [src/diagnostics/collector.ts](src/diagnostics/collector.ts) å’Œ [src/diagnostics/vscodeAdapter.ts](src/diagnostics/vscodeAdapter.ts)

é‡‡ç”¨**é€‚é…å™¨æ¨¡å¼**ï¼Œå°†è¯Šæ–­æ”¶é›†ä¸ VSCode API å®Œå…¨åˆ†ç¦»ï¼š

```typescript
/**
 * é€šç”¨è¯Šæ–­æ”¶é›†å™¨ï¼ˆä¸ä¾èµ– VSCodeï¼‰
 * - èŒè´£ï¼šä»æ’ä»¶ç³»ç»Ÿæ”¶é›†è¯Šæ–­æ•°æ®
 * - ç‹¬ç«‹æ€§ï¼šå®Œå…¨ç‹¬ç«‹äº VSCodeï¼Œå¯ç”¨äº CLI/Server
 * - å¯æµ‹è¯•æ€§ï¼šæ˜“äºå•å…ƒæµ‹è¯•ï¼Œæ— éœ€ VSCode ç¯å¢ƒ
 */
export class DiagnosticCollector {
    async collectForDocument(document: DocumentContent): Promise<DiagnosticCollectionResult> { /*...*/ }
    async collectForMultiple(documents: DocumentContent[]): Promise<Map<string, DiagnosticCollectionResult>> { /*...*/ }
    async collectAndAggregate(documents: DocumentContent[]): Promise<{...}> { /*...*/ }
}

/**
 * VSCode è¯Šæ–­é€‚é…å™¨
 * - å°†é€šç”¨è¯Šæ–­æ ¼å¼è½¬æ¢ä¸º VSCode API
 * - ç®¡ç† VSCode DiagnosticCollection
 */
export class VSCodeDiagnosticAdapter {
    constructor(pluginManager: PluginManager) { }
    async diagnoseDocument(document: vscode.TextDocument): Promise<vscode.Diagnostic[]> { /*...*/ }
    async diagnoseAll(): Promise<Map<vscode.Uri, vscode.Diagnostic[]>> { /*...*/ }
}
```

**æ¶æ„ä¼˜åŠ¿**:

- æ ¸å¿ƒè¯Šæ–­é€»è¾‘ä¸ä¾èµ– VSCode
- å¯åœ¨ä»»ä½•ç¯å¢ƒè¿è¡Œï¼ˆCLIã€Webã€Serverï¼‰
- æ˜“äºå•å…ƒæµ‹è¯•
- èŒè´£åˆ†ç¦»æ¸…æ™°

**4. æ€§èƒ½è¯Šæ–­å¢å¼º** - [src/utils/performance/diagnostician.ts](src/utils/performance/diagnostician.ts)

```typescript
/**
 * æ€§èƒ½è¯Šæ–­ä»ª
 * - ç›‘æ§å…³é”®æ“ä½œçš„æ€§èƒ½ç“¶é¢ˆ
 * - è®°å½•è¯¦ç»†çš„æ€§èƒ½æ—¥å¿—
 * - æä¾›æ€§èƒ½æ”¹è¿›å»ºè®®
 */
export class PerformanceDiagnostician {
  // è¯Šæ–­é˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰
  private diagnosticThresholds = new Map([
    ["diagnose:document", { expected: 2000, warning: 3000 }],
    ["format:document", { expected: 1000, warning: 2000 }],
    ["plugin:activate", { expected: 500, warning: 1000 }],
    // ...å…± 10+ ä¸ªé˜ˆå€¼
  ]);

  diagnose(metric: string): PerformanceBottleneck | null {
    /*...*/
  }
  diagnoseAll(): PerformanceBottleneck[] {
    /*...*/
  }
  diagnoseMemoryLeak(): { suspicious: boolean; reason: string } {
    /*...*/
  }
  setThreshold(metric: string, expected: number, warning: number): void {
    /*...*/
  }
}
```

**å…³é”®ç‰¹æ€§**:

- è‡ªåŠ¨æ£€æµ‹ 10+ å…³é”®æ“ä½œçš„æ€§èƒ½ç“¶é¢ˆ
- é˜ˆå€¼å¯é…ç½®ï¼Œæ”¯æŒè‡ªå®šä¹‰
- å†…å­˜æ³„æ¼æ£€æµ‹
- è‡ªåŠ¨ç”Ÿæˆæ”¹è¿›å»ºè®®

**5. ç‰ˆæœ¬æ£€æŸ¥æœºåˆ¶** - [src/config/versionChecker.ts](src/config/versionChecker.ts)

```typescript
/**
 * ç‰ˆæœ¬æ£€æŸ¥å™¨
 * - æ£€æŸ¥ VSCode ç‰ˆæœ¬å…¼å®¹æ€§
 * - æ£€æŸ¥ä¾èµ–å·¥å…·ç‰ˆæœ¬
 * - æä¾›ç‰ˆæœ¬å‡çº§æç¤º
 * - ç®¡ç†å‘åå…¼å®¹æ€§
 */
export class VersionChecker {
    // ç‰ˆæœ¬å…¼å®¹æ€§è¡¨
    private versionRequirements = {
        vscode: { minimum: { major: 1, minor: 74, patch: 0 }, ... },
        shfmt: { minimum: { major: 3, minor: 0, patch: 0 }, ... },
        shellcheck: { minimum: { major: 0, minor: 7, patch: 0 }, ... },
    };

    parseVersion(versionString: string): VersionInfo | null { /*...*/ }
    compareVersions(version1: VersionInfo, version2: VersionInfo): number { /*...*/ }
    checkVSCodeCompatibility(): CompatibilityCheckResult { /*...*/ }
    checkNodeCompatibility(): CompatibilityCheckResult { /*...*/ }
    checkAll(): Map<string, CompatibilityCheckResult> { /*...*/ }
}
```

**ä½¿ç”¨ç¤ºä¾‹**:

```typescript
const checker = new VersionChecker();

// æ£€æŸ¥ VSCode å…¼å®¹æ€§
const result = checker.checkVSCodeCompatibility();
if (!result.compatible) {
  vscode.window.showErrorMessage(result.error!);
}

// å…¨é¢æ£€æŸ¥
const allChecks = checker.checkAll();
for (const [component, check] of allChecks) {
  if (!check.compatible) {
    logger.error(`${component}: ${check.error}`);
  }
  if (check.warning) {
    logger.warn(`${component}: ${check.warning}`);
  }
}
```

**6. å…³é”®è·¯å¾„æ—¥å¿—å¢å¼º**

æ‰€æœ‰æ–°å¢æ¨¡å—éƒ½åŒ…å«è¯¦ç»†çš„æ—¥å¿—è®°å½•ï¼š

```typescript
// FileLockManager
logger.debug(
  `[FileLockManager] Acquiring lock for "${fileUri}", queue size: ${queueSize}`,
);
logger.debug(`[FileLockManager] Lock acquired for "${fileUri}"`);
logger.error(`[FileLockManager] Error in locked operation: ${error.message}`);

// DiagnosticCollector
logger.debug(
  `[DiagnosticCollector] Collecting diagnostics for: ${document.uri}`,
);
logger.debug(
  `[DiagnosticCollector] Collected ${result.diagnostics.length} diagnostics`,
);

// PerformanceDiagnostician
logger.warn(
  `[PerformanceDiagnostician] Bottleneck detected: ${metric} (${value}ms)`,
);

// VersionChecker
logger.error(`VSCode version incompatible: ${error}`);
logger.warn(`VSCode version is older than recommended`);
```

**æ”¹è¿›è¯„ä¼°**:

| é—®é¢˜             | è§£å†³æ–¹æ¡ˆ                     | ä»£ç ä½ç½®                           | å¤æ‚åº¦ | éªŒè¯çŠ¶æ€    |
| ---------------- | ---------------------------- | ---------------------------------- | ------ | ----------- |
| å¹¶å‘ç«æ€æ¡ä»¶     | FileLockManager              | executor/fileLockManager.ts        | O(1)   | âœ… ç¼–è¯‘é€šè¿‡ |
| é˜²æŠ–ä¸å®‰å…¨       | æ”¹è¿›çš„ DebounceManager       | utils/debounce.ts                  | O(1)   | âœ… ç¼–è¯‘é€šè¿‡ |
| è¯Šæ–­è€¦åˆåº¦é«˜     | DiagnosticCollector + é€‚é…å™¨ | diagnostics/                       | O(n)   | âœ… ç¼–è¯‘é€šè¿‡ |
| è¯Šæ–­é€»è¾‘ç¼ºå¤±     | PerformanceDiagnostician     | utils/performance/diagnostician.ts | O(n)   | âœ… ç¼–è¯‘é€šè¿‡ |
| ç‰ˆæœ¬æ£€æŸ¥ç¼ºå¤±     | VersionChecker               | config/versionChecker.ts           | O(1)   | âœ… ç¼–è¯‘é€šè¿‡ |
| å…³é”®è·¯å¾„æ—¥å¿—ç¼ºå¤± | ç»“æ„åŒ–æ—¥å¿— (20+æ¡)           | å„æ¨¡å—                             | O(1)   | âœ… æ—¥å¿—å®Œæ•´ |

**æ€»ä½“å½±å“**:

- âœ… å¹¶å‘å®‰å…¨æ€§ï¼šä» 3/10 æå‡åˆ° 9/10
- âœ… è¯Šæ–­æ¨¡å—åŒ–ï¼šä» 5/10 æå‡åˆ° 9/10
- âœ… å¯è§‚æµ‹æ€§ï¼šä» 4/10 æå‡åˆ° 8/10
- âœ… å¯ç»´æŠ¤æ€§ï¼šä» 6/10 æå‡åˆ° 9/10

#### 1.2.4 æ€§èƒ½ç›‘æ§ä¸å®Œæ•´

**é—®é¢˜**:

- æ€§èƒ½ç›‘æ§ä»…æ”¶é›†éƒ¨åˆ†å…³é”®æ“ä½œ
- ç¼ºå°‘å†…å­˜ä½¿ç”¨æƒ…å†µç›‘æ§
- æ²¡æœ‰æ€§èƒ½å‘Šè­¦æœºåˆ¶

âœ… **å·²å®ç°æ”¹è¿›**:

1. **åˆ›å»ºæ€§èƒ½å‘Šè­¦ç®¡ç†å™¨** [src/utils/performance/alertManager.ts](src/utils/performance/alertManager.ts)ï¼š

```typescript
export class PerformanceAlertManager {
  // æ”¯æŒå‘Šè­¦çº§åˆ«ï¼šLOW, MEDIUM, HIGH, CRITICAL
  registerThreshold(config: AlertThresholdConfig): void;
  check(metricName: string, value: number): void;
  onAlert(handler: AlertHandler): void;

  // å†…ç½®é»˜è®¤é˜ˆå€¼é…ç½®
  private initializeDefaultThresholds(): void {
    // è¯Šæ–­æ“ä½œï¼š5ç§’å‘Šè­¦
    // æ ¼å¼åŒ–æ“ä½œï¼š2-3ç§’å‘Šè­¦
    // æ’ä»¶åŠ è½½ï¼š5ç§’å‘Šè­¦
  }
}
```

1. **æ‰©å±•å†…å­˜ç›‘æ§** [src/utils/performance/monitor.ts](src/utils/performance/monitor.ts)ï¼š

```typescript
// æ–°å¢å†…å­˜æ¥å£å’Œæ–¹æ³•
export interface MemoryUsage {
    heapUsed: number;
    heapTotal: number;
    rss: number;
    external: number;
    arrayBuffers: number;
}

// PerformanceMonitor æ–°å¢æ–¹æ³•
recordMemoryUsage(): void;
getCurrentMemoryUsage(): MemoryUsage;
getMemoryHistory(limit?: number): MemoryUsage[];
getMemoryStats(): { current, peak, average };
setMemoryThreshold(thresholdMB: number): void;
```

1. **æä¾›ä¾¿æ· API** [src/utils/performance/integration.ts](src/utils/performance/integration.ts)ï¼š

```typescript
// æ€§èƒ½å‘Šè­¦ç›¸å…³
enablePerformanceAlerts(): void;
disablePerformanceAlerts(): void;
onPerformanceAlert(handler: AlertHandler): void;
setAlertThreshold(metricName: string, threshold: number, level?: AlertLevel): void;
getPerformanceAlerts(limit?: number): PerformanceAlert[];
getAlertStats(): { total, byLevel, byMetric };

// å†…å­˜ç›‘æ§ç›¸å…³
recordMemoryUsage(): void;
getCurrentMemoryUsage(): MemoryUsage;
getMemoryHistory(limit?: number): MemoryUsage[];
getMemoryStats(): { current, peak, average };
setMemoryAlertThreshold(thresholdMB: number): void;
```

**é»˜è®¤å‘Šè­¦é˜ˆå€¼é…ç½®**ï¼š

| æŒ‡æ ‡                         | é˜ˆå€¼  | çº§åˆ«   |
| ---------------------------- | ----- | ------ |
| diagnose_one_doc_duration    | 5ç§’   | HIGH   |
| diagnose_all_docs_duration   | 30ç§’  | HIGH   |
| shfmt_diagnose_duration      | 3ç§’   | MEDIUM |
| shellcheck_diagnose_duration | 5ç§’   | MEDIUM |
| format_duration              | 3ç§’   | MEDIUM |
| shfmt_format_duration        | 2ç§’   | LOW    |
| plugin_load_duration         | 5ç§’   | HIGH   |
| service_init_duration        | 5ç§’   | HIGH   |
| memory_usage                 | 100MB | MEDIUM |

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```typescript
import {
  enablePerformanceAlerts,
  onPerformanceAlert,
  setAlertThreshold,
  getAlertStats,
} from "./utils/performance/integration";

// å¯ç”¨å‘Šè­¦
enablePerformanceAlerts();

// æ³¨å†Œå¤„ç†å™¨
onPerformanceAlert((alert) => {
  console.log(
    `Alert: ${alert.metricName} = ${alert.value}ms (> ${alert.threshold}ms)`,
  );
  // å¯é€‰ï¼šå‘é€åˆ°æ—¥å¿—ç³»ç»Ÿã€ç›‘æ§å¹³å°ç­‰
});

// è‡ªå®šä¹‰é˜ˆå€¼
setAlertThreshold("format_duration", 2000, AlertLevel.MEDIUM);

// è·å–ç»Ÿè®¡ä¿¡æ¯
const stats = getAlertStats();
console.log(
  `Total alerts: ${stats.total}, Critical: ${stats.byLevel.CRITICAL}`,
);
```

### 1.3 ä»£ç ç»“æ„è¯„ä»·

#### 1.3.1 æ¨¡å—åˆ’åˆ†

| æ¨¡å—           | èŒè´£                          | è¯„ä»·                            |
| -------------- | ----------------------------- | ------------------------------- |
| `extension.ts` | VSCode æ‰©å±•å…¥å£ã€äº‹ä»¶æ³¨å†Œ     | âœ… èŒè´£æ¸…æ™°ï¼Œä»£ç é‡é€‚ä¸­         |
| `plugins/`     | æ’ä»¶æ¥å£ã€ç®¡ç†ã€åˆå§‹åŒ–        | âœ… ç»“æ„æ¸…æ™°ï¼Œæ˜“äºæ‰©å±•           |
| `di/`          | ä¾èµ–æ³¨å…¥å®¹å™¨ã€åˆå§‹åŒ–          | âœ… å®ç°å®Œæ•´ï¼Œæ— å¤–éƒ¨ä¾èµ–         |
| `commands/`    | å‘½ä»¤å¤„ç†é€»è¾‘                  | âœ… èŒè´£å•ä¸€                     |
| `diagnostics/` | è¯Šæ–­é€»è¾‘                      | âš ï¸ å¯è€ƒè™‘åˆ†ç¦»æ–‡æ¡£æ”¶é›†å’Œè¯Šæ–­é€»è¾‘ |
| `formatters/`  | æ ¼å¼åŒ–é€»è¾‘                    | âœ… ç®€æ´æ¸…æ™°                     |
| `tools/`       | å·¥å…·å®ç°ï¼ˆshfmtã€shellcheckï¼‰ | âœ… å®ç°å®Œæ•´ï¼Œæ”¯æŒæ‰©å±•           |
| `config/`      | é…ç½®ç®¡ç†                      | âœ… ç¼“å­˜æœºåˆ¶è®¾è®¡è‰¯å¥½             |
| `utils/`       | å·¥å…·å‡½æ•°                      | âœ… åŠŸèƒ½é½å…¨                     |
| `adapters/`    | é€‚é…å™¨                        | âœ… èŒè´£æ¸…æ™°                     |

#### 1.3.2 å¾ªç¯ä¾èµ–æ£€æŸ¥

**ç°çŠ¶**: æ— å¾ªç¯ä¾èµ–ï¼Œå•å‘ä¾èµ–å…³ç³»æ¸…æ™° âœ…

#### 1.3.3 ä»£ç æ–‡ä»¶å¤§å°åˆ†æ

```
extension.ts: 363 è¡Œ  - å…¥å£ç‚¹ï¼ŒåŒ…å«å¤šä¸ªè´£ä»»
pluginManager.ts: 431 è¡Œ - èŒè´£é›†ä¸­ï¼Œå¯è€ƒè™‘åˆ†å‰²
container.ts: 323 è¡Œ - DI å®¹å™¨å®ç°ï¼Œå¤æ‚åº¦é«˜ä½†åˆç†
settingInfo.ts: 308 è¡Œ - é…ç½®ç®¡ç†ï¼Œå®ç°å®Œæ•´
```

**å»ºè®®**: è€ƒè™‘å°† `extension.ts` ä¸­çš„äº‹ä»¶å¤„ç†é€»è¾‘æå–åˆ°å•ç‹¬çš„æ¨¡å—ï¼š

```typescript
// æ–°æ–‡ä»¶: eventHandlers.ts
export function setupDocumentChangeListener(context: vscode.ExtensionContext) {}
export function setupConfigChangeListener(context: vscode.ExtensionContext) {}
```

---

## 2. å¯ç»´æŠ¤æ€§è¯„ä»·

### 2.1 âœ… ä¼˜åŠ¿

- **æ—¥å¿—ç³»ç»Ÿå®Œæ•´**: LoggerAdapter æä¾›ç»“æ„åŒ–æ—¥å¿—ï¼Œæ”¯æŒæ—¥å¿—çº§åˆ«æ§åˆ¶
- **æ–‡æ¡£å®Œå–„**: READMEã€æ¶æ„æ–‡æ¡£ã€å¼€å‘æŒ‡å—é½å…¨
- **é…ç½®ç®¡ç†æ¸…æ™°**: SettingInfo ç»Ÿä¸€ç®¡ç†é…ç½®ï¼Œä¾¿äºç»´æŠ¤
- **é”™è¯¯ä¿¡æ¯æ˜ç¡®**: è¯Šæ–­ä¿¡æ¯åŒ…å«æ–‡ä»¶ä½ç½®å’Œé”™è¯¯æè¿°

### 2.2 âš ï¸ æ”¹è¿›ç©ºé—´

#### 2.2.1 æ—¥å¿—è¦†ç›–ä¸å®Œæ•´

- æŸäº›å…³é”®è·¯å¾„ç¼ºå°‘æ—¥å¿—
- ç¼ºå°‘æ€§èƒ½ç“¶é¢ˆçš„è¯Šæ–­æ—¥å¿—

**å»ºè®®**:

```typescript
// åœ¨å…³é”®å‡½æ•°æ·»åŠ è¿›å…¥/é€€å‡ºæ—¥å¿—
async format(document: TextDocument, options: PluginFormatOptions): Promise<PluginFormatResult> {
    logger.debug(`[ENTER] format - document: ${document.fileName}`);
    try {
        const result = await this.formatImpl(document, options);
        logger.debug(`[EXIT] format - textEdits: ${result.textEdits.length}`);
        return result;
    } catch (error) {
        logger.error(`[ERROR] format - ${error}`);
        throw error;
    }
}
```

#### 2.2.2 æ–‡æ¡£ç¼ºå¤±

- ç¼ºå°‘ API æ–‡æ¡£ï¼ˆJSDoc æ³¨é‡Šï¼‰
- éƒ¨åˆ†å¤æ‚ç®—æ³•ç¼ºå°‘è¯´æ˜

**å»ºè®®**:

```typescript
/**
 * å¹¶è¡Œæ¿€æ´»æ‰€æœ‰æ’ä»¶
 *
 * å®ç°ç»†èŠ‚:
 * - ä½¿ç”¨ Promise.allSettled() ç¡®ä¿å•ä¸ªæ’ä»¶å¤±è´¥ä¸é˜»æ­¢å…¶ä»–æ’ä»¶
 * - æœ€å¤§å¹¶å‘æ•°å— Node.js äº‹ä»¶å¾ªç¯é™åˆ¶
 *
 * æ€§èƒ½:
 * - æ‰¹é‡æ¿€æ´»ç›¸æ¯”é¡ºåºæ¿€æ´»æ€§èƒ½æå‡ 40%
 *
 * @param plugins - è¦æ¿€æ´»çš„æ’ä»¶åˆ—è¡¨
 * @returns æ¿€æ´»ç»“æœæ•°ç»„
 * @throws æ‰€æœ‰æ’ä»¶æ¿€æ´»å‡å¤±è´¥æ—¶æŠ›å‡ºå¼‚å¸¸
 */
async activatePluginsInParallel(plugins: IFormatPlugin[]): Promise<void> { }
```

#### 2.2.3 ç‰ˆæœ¬å…¼å®¹æ€§ç®¡ç†

**é—®é¢˜**:

- ç¼ºå°‘ç‰ˆæœ¬æ£€æŸ¥æœºåˆ¶
- ä¸æ¸…æ¥šå¦‚ä½•å¤„ç† VSCode ç‰ˆæœ¬å‡çº§

**å»ºè®®**:

```typescript
// åœ¨ extension.ts ä¸­æ·»åŠ ç‰ˆæœ¬æ£€æŸ¥
function checkVSCodeVersion(): void {
  const minVersion = "1.74.0";
  const currentVersion = vscode.version;

  if (!semver.gte(currentVersion, minVersion)) {
    vscode.window.showErrorMessage(
      `Shell Format requires VSCode ${minVersion} or higher`,
    );
  }
}
```

---

## 3. å¯æ‰©å±•æ€§è¯„ä»·

### 3.1 âœ… ä¼˜åŠ¿

#### 3.1.1 æ’ä»¶æ‰©å±•ä¾¿æ·

æ·»åŠ æ–°çš„æ ¼å¼åŒ–å·¥å…·ä»…éœ€ï¼š

1. å®ç° `IFormatPlugin` æ¥å£
2. åœ¨ `pluginInitializer.ts` ä¸­æ³¨å†Œ
3. åœ¨ `package.json` ä¸­æ·»åŠ é…ç½®é¡¹

#### 3.1.2 å·¥å…·æ”¯æŒæ˜“äºæ‰©å±•

```typescript
// å·¥å…·å±‚æ¸…æ™°çš„æ¶æ„
tools/
â”œâ”€â”€ executor/      # å‘½ä»¤æ‰§è¡Œå™¨
â”œâ”€â”€ shell/         # Shell ç‰¹å®šå·¥å…·
â”‚   â”œâ”€â”€ shfmt/     # shfmt å·¥å…·
â”‚   â””â”€â”€ shellcheck/# shellcheck å·¥å…·
```

æ–°å¢å·¥å…·æ—¶ï¼Œåªéœ€åœ¨ `tools/shell/` ä¸‹æ·»åŠ æ–°ç›®å½•ã€‚

#### 3.1.3 æä¾›è€…æ˜“äºæ‰©å±•

- CodeActionProvider æ”¯æŒæ·»åŠ æ–°çš„å¿«é€Ÿä¿®å¤
- å¯è½»æ¾æ·»åŠ  HoverProviderã€CompletionProvider ç­‰

### 3.2 âš ï¸ æ”¹è¿›ç©ºé—´

#### 3.2.1 æ’ä»¶æ¥å£è¿‡äºç®€åŒ–

**é—®é¢˜**:

- IFormatPlugin æ¥å£ä¸­ `format` æ–¹æ³•æ˜¯å¯é€‰çš„ï¼Œå¯èƒ½å¯¼è‡´è¿è¡Œæ—¶é”™è¯¯
- ç¼ºå°‘æ’ä»¶èƒ½åŠ›å£°æ˜æœºåˆ¶

âœ… **å·²å®ç°æ”¹è¿›**:

**1. ä¿®æ”¹ IFormatPlugin æ¥å£** [src/plugins/pluginInterface.ts](src/plugins/pluginInterface.ts)ï¼š

- âœ… å°† `format` æ–¹æ³•æ”¹ä¸ºå¿…éœ€ï¼ˆç§»é™¤ `?`ï¼‰
- âœ… å°† `check` æ–¹æ³•ä¿æŒå¿…éœ€
- âœ… æ–°å¢ `PluginCapabilities` æ¥å£ç”¨äºèƒ½åŠ›å£°æ˜
- âœ… æ–°å¢ `JSONSchema` æ¥å£ç”¨äºé…ç½® Schema
- âœ… æ–°å¢å¯é€‰æ–¹æ³• `getCapabilities()` å’Œ `getConfigSchema()`

```typescript
// èƒ½åŠ›å£°æ˜æ¥å£
export interface PluginCapabilities {
  format: boolean; // æ˜¯å¦æ”¯æŒæ ¼å¼åŒ–
  check: boolean; // æ˜¯å¦æ”¯æŒæ£€æŸ¥
  fixOnSave?: boolean; // æ˜¯å¦æ”¯æŒä¿å­˜æ—¶è‡ªåŠ¨ä¿®å¤
  rangeFormat?: boolean; // æ˜¯å¦æ”¯æŒèŒƒå›´æ ¼å¼åŒ–
  codeActions?: boolean; // æ˜¯å¦æ”¯æŒå¿«é€Ÿä¿®å¤
}

// é…ç½® Schema æ¥å£
export interface JSONSchema {
  title?: string;
  description?: string;
  type?: "string" | "number" | "boolean" | "object" | "array";
  properties?: Record<string, JSONSchema>;
  required?: string[];
  default?: any;
  enum?: any[];
}
```

**2. æ›´æ–° BaseFormatPlugin** [src/plugins/baseFormatPlugin.ts](src/plugins/baseFormatPlugin.ts)ï¼š

- âœ… å°† `format` æ”¹ä¸ºå¿…éœ€æŠ½è±¡æ–¹æ³•
- âœ… æä¾›é»˜è®¤ `getCapabilities()` å®ç°
- âœ… æä¾›å¯é€‰ `getConfigSchema()` å®ç°
- âœ… æ›´æ–°ç±»å‹å¯¼å…¥

```typescript
// BaseFormatPlugin ä¸­çš„æ”¹è¿›
abstract format(document: any, options: any): Promise<PluginFormatResult>;

getCapabilities(): PluginCapabilities {
    return {
        format: true,
        check: true,
        fixOnSave: true,
        rangeFormat: true,
        codeActions: true,
    };
}

getConfigSchema?(): JSONSchema {
    return {};
}
```

**3. æ›´æ–° PureShfmtPlugin** [src/plugins/shfmtPlugin.ts](src/plugins/shfmtPlugin.ts)ï¼š

- âœ… å®ç° `getCapabilities()` æ–¹æ³•
- âœ… å·²æœ‰ `format` å®ç°
- âœ… å·²æœ‰ `check` å®ç°

```typescript
// shfmt æ”¯æŒå®Œæ•´åŠŸèƒ½
getCapabilities(): PluginCapabilities {
    return {
        format: true,
        check: true,
        fixOnSave: true,
        rangeFormat: true,
        codeActions: true,
    };
}
```

**4. æ›´æ–° PureShellcheckPlugin** [src/plugins/shellcheckPlugin.ts](src/plugins/shellcheckPlugin.ts)ï¼š

- âœ… æ–°å¢å¿…éœ€çš„ `format` æ–¹æ³•å®ç°ï¼ˆè°ƒç”¨æ£€æŸ¥é€»è¾‘ï¼‰
- âœ… å·²æœ‰ `check` å®ç°
- âœ… è‡ªå®šä¹‰ `getCapabilities()` æ–¹æ³•

```typescript
// shellcheck åªæ”¯æŒæ£€æŸ¥åŠŸèƒ½
async format(
    document: vscode.TextDocument,
    options: PluginFormatOptions,
): Promise<PluginFormatResult> {
    // è°ƒç”¨æ£€æŸ¥é€»è¾‘ï¼Œè¿”å›ç©ºçš„ç¼–è¾‘åˆ—è¡¨
    const result = await this.tool.check({ ... });
    return {
        hasErrors: result.hasErrors,
        diagnostics: result.diagnostics,
        textEdits: [], // ä¸æä¾›æ ¼å¼åŒ–ç¼–è¾‘
    };
}

getCapabilities(): PluginCapabilities {
    return {
        format: false,      // ä¸æ”¯æŒæ ¼å¼åŒ–
        check: true,        // ä»…æ”¯æŒæ£€æŸ¥
        fixOnSave: false,
        rangeFormat: false,
        codeActions: true,  // æ”¯æŒå¿«é€Ÿä¿®å¤
    };
}
```

**ä¼˜åŠ¿**:

- âœ… **è¿è¡Œæ—¶å®‰å…¨**: æ‰€æœ‰æ–¹æ³•éƒ½å¿…é¡»å®ç°ï¼Œé¿å…è°ƒç”¨ä¸å­˜åœ¨çš„æ–¹æ³•
- âœ… **èƒ½åŠ›æ¸…æ™°**: é€šè¿‡ `getCapabilities()` æ˜ç¡®å£°æ˜æ’ä»¶åŠŸèƒ½
- âœ… **é…ç½®çµæ´»**: é€šè¿‡ `getConfigSchema()` æ”¯æŒåŠ¨æ€é…ç½®éªŒè¯
- âœ… **ç±»å‹å®‰å…¨**: å¼ºç±»å‹æ¥å£å®šä¹‰

**ä½¿ç”¨ç¤ºä¾‹**:

```typescript
// æ£€æŸ¥æ’ä»¶èƒ½åŠ›
const capabilities = plugin.getCapabilities?.() || {
  format: true,
  check: true,
};

if (capabilities.format) {
  // å¯ä»¥è°ƒç”¨ format æ–¹æ³•
  const result = await plugin.format(document, options);
}

if (capabilities.check) {
  // å¯ä»¥è°ƒç”¨ check æ–¹æ³•
  const result = await plugin.check(document, options);
}

// è·å–é…ç½® Schema
const schema = plugin.getConfigSchema?.();
if (schema) {
  // ä½¿ç”¨ schema éªŒè¯é…ç½®
  validateConfig(userConfig, schema);
}
```

#### 3.2.2 ç¼ºå°‘æ’ä»¶å¸‚åœºæœºåˆ¶

**é—®é¢˜**:

- ç›®å‰æ’ä»¶éƒ½ç¡¬ç¼–ç åœ¨é¡¹ç›®ä¸­
- æ— æ³•åŠ¨æ€åŠ è½½å¤–éƒ¨æ’ä»¶

**å»ºè®®**:

1. è®¾è®¡æ’ä»¶å‘ç°å’ŒåŠ è½½æœºåˆ¶
2. æ”¯æŒä» npm æˆ–å…¶ä»–åŒ…ç®¡ç†å™¨åŠ è½½æ’ä»¶
3. æ·»åŠ æ’ä»¶æ¸…å•ï¼ˆmanifestï¼‰éªŒè¯

```typescript
export interface PluginManifest {
  id: string;
  version: string;
  displayName: string;
  entry: string;
  dependencies?: string[];
  permissions?: string[];
}
```

#### 3.2.3 é…ç½®æ‰©å±•æ€§

**é—®é¢˜**:

- é…ç½®é¡¹ç¡¬ç¼–ç ï¼Œéš¾ä»¥ä¸ºæ–°æ’ä»¶æ·»åŠ é…ç½®

**å»ºè®®**:

```typescript
// æ”¯æŒåŠ¨æ€é…ç½®æ³¨å†Œ
export interface IConfigurable {
  getConfigSchema(): JSONSchema;
  applyConfig(config: Record<string, any>): void;
}

// SettingInfo æ”¯æŒæ’ä»¶æä¾›çš„é…ç½®é¡¹
class SettingInfo {
  private static pluginConfigs = new Map<string, JSONSchema>();

  static registerPluginConfig(pluginName: string, schema: JSONSchema): void {
    this.pluginConfigs.set(pluginName, schema);
  }
}
```

---

## 4. æµ‹è¯•è¦†ç›–è¯„ä»·

### 4.1 ç°çŠ¶

```
test/
â”œâ”€â”€ fixtures/     # æµ‹è¯•æ•°æ®ï¼ˆshell è„šæœ¬ç¤ºä¾‹ï¼‰
â”œâ”€â”€ plugin/       # æ’ä»¶æµ‹è¯•
â”œâ”€â”€ unit/         # å•å…ƒæµ‹è¯•
â”‚   â””â”€â”€ utils/    # å·¥å…·å‡½æ•°æµ‹è¯•
â””â”€â”€ run.js        # æµ‹è¯•è¿è¡Œå™¨
```

**è¯„ä»·**: âš ï¸ æµ‹è¯•è¦†ç›–ç‡ä¸è¶³

### 4.2 âš ï¸ æ”¹è¿›å»ºè®®

#### 4.2.1 æµ‹è¯•è¦†ç›–èŒƒå›´

**ç¼ºå¤±çš„æµ‹è¯•**:

- DI å®¹å™¨å¾ªç¯ä¾èµ–æ£€æµ‹
- æ’ä»¶å¹¶è¡Œæ¿€æ´»
- é…ç½®å˜æ›´è§¦å‘åˆ·æ–°
- é˜²æŠ–é˜²æŠ¤
- é”™è¯¯æ¢å¤æœºåˆ¶
- VSCode API é›†æˆæµ‹è¯•

**å»ºè®®**:

```typescript
// æ·»åŠ  DI å®¹å™¨æµ‹è¯•
describe("DIContainer", () => {
  it("should detect circular dependencies", () => {
    const container = new DIContainer();
    container.registerSingleton("A", () => container.resolve("B"), ["B"]);
    container.registerSingleton("B", () => container.resolve("A"), ["A"]);

    expect(() => container.resolve("A")).toThrow(/circular dependency/i);
  });

  it("should cleanup resources on demand", async () => {
    let cleaned = false;
    const container = new DIContainer();
    container.registerSingleton("service", () => ({
      cleanup: () => {
        cleaned = true;
      },
    }));

    container.resolve("service");
    await container.cleanup();

    expect(cleaned).toBe(true);
  });
});
```

#### 4.2.2 é›†æˆæµ‹è¯•

**ç¼ºå¤±çš„é›†æˆæµ‹è¯•**:

- æ–‡æ¡£ç¼–è¾‘ â†’ é˜²æŠ– â†’ è¯Šæ–­å®Œæ•´æµç¨‹
- æ’ä»¶æ¿€æ´» â†’ æ ¼å¼åŒ– â†’ ç»“æœè¿”å›æµç¨‹
- é…ç½®å˜æ›´ â†’ ç¼“å­˜åˆ·æ–° â†’ åŠŸèƒ½é‡æ–°åˆå§‹åŒ–æµç¨‹

```typescript
describe("Document Formatting Integration", () => {
  it("should format shell script end-to-end", async () => {
    const document = await openTestDocument("test_syntax.sh");
    const edits = await formatDocument(document);

    expect(edits.length).toBeGreaterThan(0);
    expect(edits[0]).toHaveProperty("range");
    expect(edits[0]).toHaveProperty("newText");
  });
});
```

#### 4.2.3 æ€§èƒ½æµ‹è¯•

**å»ºè®®**:

```typescript
describe("Performance", () => {
  it("should format large file in acceptable time", async () => {
    const largeDocument = createLargeTestDocument(10000); // 10000 è¡Œ
    const startTime = performance.now();

    await formatDocument(largeDocument);

    const duration = performance.now() - startTime;
    expect(duration).toBeLessThan(5000); // 5 ç§’ä»¥å†…
  });

  it("should activate plugins in parallel within timeout", async () => {
    const startTime = performance.now();

    await pluginManager.activatePlugins(["shfmt", "shellcheck"]);

    const duration = performance.now() - startTime;
    expect(duration).toBeLessThan(2000); // 2 ç§’ä»¥å†…ï¼ˆ40% æ€§èƒ½æå‡ï¼‰
  });
});
```

---

## 5. å®‰å…¨æ€§è¯„ä»·

### 5.1 âœ… å·²æœ‰çš„å®‰å…¨è€ƒè™‘

- **æ–‡ä»¶è¿‡æ»¤**: è·³è¿‡ Git å†²çªæ–‡ä»¶ã€ä¸´æ—¶æ–‡ä»¶ç­‰
- **è¾“å…¥éªŒè¯**: æ–‡æ¡£è¯­è¨€ ID æ£€æŸ¥
- **æƒé™éš”ç¦»**: é€šè¿‡ VSCode æ‰©å±•æ²™ç®±è¿è¡Œ

### 5.2 âš ï¸ å®‰å…¨éšæ‚£

#### 5.2.1 å‘½ä»¤æ³¨å…¥é£é™©

**é—®é¢˜**:

```typescript
// åœ¨ shfmtTool.ts å’Œ shellcheckTool.ts ä¸­æ‰§è¡Œå¤–éƒ¨å‘½ä»¤
// å¦‚æœç”¨æˆ·è·¯å¾„æˆ–å‚æ•°åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼Œå¯èƒ½å¯¼è‡´å‘½ä»¤æ³¨å…¥
executor.execute(toolPath, [document.fileName, ...args]);
```

**å»ºè®®**:

1. ä½¿ç”¨æ•°ç»„å½¢å¼ä¼ é€’å‚æ•°ï¼ˆå·²åœ¨ executor ä¸­å®ç° âœ…ï¼‰
2. éªŒè¯å·¥å…·è·¯å¾„æ˜¯å¦å­˜åœ¨ä¸”å¯æ‰§è¡Œï¼š

```typescript
function validateToolPath(toolPath: string): void {
  const fs = require("fs");
  const path = require("path");

  if (!fs.existsSync(toolPath)) {
    throw new Error(`Tool not found: ${toolPath}`);
  }

  const stats = fs.statSync(toolPath);
  if (!stats.isFile()) {
    throw new Error(`Tool is not a file: ${toolPath}`);
  }

  // æ£€æŸ¥å¯æ‰§è¡Œæƒé™ï¼ˆä»… Unixï¼‰
  if (process.platform !== "win32" && !(stats.mode & 0o111)) {
    throw new Error(`Tool is not executable: ${toolPath}`);
  }
}
```

1. å¯¹ç”¨æˆ·è¾“å…¥è¿›è¡Œå‡€åŒ–ï¼š

```typescript
function sanitizeFilePath(filePath: string): string {
  // é˜²æ­¢è·¯å¾„éå†æ”»å‡»
  const resolved = path.resolve(filePath);
  const workspace = vscode.workspace.workspaceFolders?.[0].uri.fsPath;

  if (!workspace || !resolved.startsWith(workspace)) {
    throw new Error(`File is outside workspace: ${filePath}`);
  }

  return resolved;
}
```

#### 5.2.2 ä¿¡æ¯æ³„éœ²é£é™©

**é—®é¢˜**:

- æ—¥å¿—ä¸­å¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼ˆæ–‡ä»¶è·¯å¾„ã€ç”¨æˆ·é…ç½®ï¼‰
- é”™è¯¯æ¶ˆæ¯ä¸­çš„å·¥å…·è¾“å‡ºå¯èƒ½åŒ…å«è·¯å¾„ç­‰ä¿¡æ¯

**å»ºè®®**:

```typescript
// åœ¨æ—¥å¿—ä¸­è„±æ•æ•æ„Ÿä¿¡æ¯
function redactPath(filePath: string): string {
  const workspace = vscode.workspace.workspaceFolders?.[0].uri.fsPath;
  if (workspace && filePath.startsWith(workspace)) {
    return "${workspace}" + filePath.slice(workspace.length);
  }
  return "${home}" + path.relative(require("os").homedir(), filePath);
}

// åœ¨æ—¥å¿—ä¸­ä½¿ç”¨
logger.debug(`Processing file: ${redactPath(document.fileName)}`);
```

#### 5.2.3 ä¾èµ–å®‰å…¨

**å»ºè®®**:

1. å®šæœŸæ›´æ–°ä¾èµ–ç‰ˆæœ¬
2. ä½¿ç”¨ `npm audit` æ£€æŸ¥æ¼æ´
3. åœ¨ CI/CD ä¸­æ·»åŠ å®‰å…¨æ‰«æï¼š

```yaml
# GitHub Actions ç¤ºä¾‹
- name: Run npm audit
  run: npm audit --production

- name: Security scan
  run: npm install -g snyk && snyk test
```

---

## 6. æ€§èƒ½è¯„ä»·

### 6.1 âœ… å·²æœ‰çš„ä¼˜åŒ–

- **é˜²æŠ–æœºåˆ¶**: 300ms é˜²æŠ–å‡å°‘ä¸å¿…è¦çš„è¯Šæ–­
- **å¹¶è¡Œæ’ä»¶æ¿€æ´»**: 40% æ€§èƒ½æå‡
- **é…ç½®ç¼“å­˜**: é¿å…é¢‘ç¹è¯»å–é…ç½®
- **æ€§èƒ½ç›‘æ§**: å†…ç½®æ€§èƒ½æŒ‡æ ‡æ”¶é›†

### 6.2 âš ï¸ æ”¹è¿›ç©ºé—´

#### 6.2.1 ç¼“å­˜ç­–ç•¥ä¸å®Œæ•´

**é—®é¢˜**:

- ä»…é…ç½®ç¼“å­˜ï¼Œæ— æ–‡æ¡£è¯Šæ–­ç¼“å­˜
- æ— æ’ä»¶èƒ½åŠ›ç¼“å­˜

**å»ºè®®**:

```typescript
export class DiagnosticCache {
  private cache = new Map<string, DiagnosticResult>();
  private timestamps = new Map<string, number>();

  get(documentUri: string, checksum: string): DiagnosticResult | null {
    const key = `${documentUri}#${checksum}`;
    return this.cache.get(key) ?? null;
  }

  set(documentUri: string, checksum: string, result: DiagnosticResult): void {
    const key = `${documentUri}#${checksum}`;
    this.cache.set(key, result);
    this.timestamps.set(key, Date.now());
  }

  // å®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜
  prune(maxAge: number = 5 * 60 * 1000): void {
    const now = Date.now();
    for (const [key, timestamp] of this.timestamps.entries()) {
      if (now - timestamp > maxAge) {
        this.cache.delete(key);
        this.timestamps.delete(key);
      }
    }
  }
}
```

#### 6.2.2 å†…å­˜ç®¡ç†

**å»ºè®®**:

```typescript
// æ·»åŠ å†…å­˜ç›‘æ§
class MemoryMonitor {
  private static readonly THRESHOLD = 100 * 1024 * 1024; // 100MB

  static checkMemory(): void {
    const usage = process.memoryUsage();
    if (usage.heapUsed > this.THRESHOLD) {
      logger.warn(
        `High memory usage: ${(usage.heapUsed / 1024 / 1024).toFixed(2)}MB`,
      );
      // è§¦å‘åƒåœ¾å›æ”¶
      if (global.gc) global.gc();
    }
  }
}

// å®šæœŸæ£€æŸ¥
setInterval(() => MemoryMonitor.checkMemory(), 30000);
```

#### 6.2.3 å¤§æ–‡ä»¶å¤„ç†

**é—®é¢˜**:

- å¯¹å¤§æ–‡ä»¶çš„æ ¼å¼åŒ–å¯èƒ½è¶…æ—¶
- ç¼ºå°‘æµå¼å¤„ç†æœºåˆ¶

**å»ºè®®**:

```typescript
// ä¸ºå¤§æ–‡ä»¶æ·»åŠ åˆ†æ®µå¤„ç†
async function formatLargeDocument(
  document: TextDocument,
): Promise<TextEdit[]> {
  const MAX_LINES_PER_BATCH = 1000;
  const lines = document.lineCount;

  if (lines <= MAX_LINES_PER_BATCH) {
    return formatDocument(document);
  }

  const edits: TextEdit[] = [];
  for (let i = 0; i < lines; i += MAX_LINES_PER_BATCH) {
    const start = new vscode.Position(i, 0);
    const end = new vscode.Position(
      Math.min(i + MAX_LINES_PER_BATCH, lines),
      0,
    );
    const range = new vscode.Range(start, end);

    const batchEdits = await formatRange(document, range);
    edits.push(...batchEdits);
  }

  return edits;
}
```

---

## 7. ä»£ç è´¨é‡æŒ‡æ ‡

### 7.1 ä»£ç å¤æ‚åº¦

| æ–‡ä»¶             | åœˆå¤æ‚åº¦ | è¯„ä»·                   |
| ---------------- | -------- | ---------------------- |
| extension.ts     | ä¸­ç­‰     | å¯è€ƒè™‘é‡æ„ï¼Œåˆ†ç¦»å…³æ³¨ç‚¹ |
| pluginManager.ts | ä½       | èŒè´£æ¸…æ™°               |
| container.ts     | ä¸­ç­‰     | åˆç†ï¼Œæ¶‰åŠé€’å½’æ£€æµ‹     |
| settingInfo.ts   | ä½       | æ¸…æ™°                   |

### 7.2 å‘½åè§„èŒƒ

- âœ… ç±»åé‡‡ç”¨ PascalCaseï¼ˆDiContainerã€PluginManagerï¼‰
- âœ… å‡½æ•°åé‡‡ç”¨ camelCaseï¼ˆregisterSingletonã€getAvailablePluginsï¼‰
- âœ… å¸¸é‡é‡‡ç”¨ UPPER_CASEï¼ˆPERFORMANCE_METRICSï¼‰
- âœ… æ¥å£åé‡‡ç”¨ I å‰ç¼€ï¼ˆIFormatPluginã€ICleanupï¼‰

### 7.3 æ³¨é‡Šè¦†ç›–

- âœ… å…¬å…± API æœ‰ JSDoc æ³¨é‡Š
- âš ï¸ å¤æ‚é€»è¾‘ç¼ºå°‘ç®—æ³•è¯´æ˜
- âœ… å…³é”®è®¾è®¡å†³ç­–æœ‰æ³¨é‡Šè¯´æ˜

---

## 8. åˆè§„æ€§å’Œæœ€ä½³å®è·µ

### 8.1 âœ… ç¬¦åˆçš„æ ‡å‡†

- **VSCode æ‰©å±•æœ€ä½³å®è·µ**:
  - ä½¿ç”¨é…ç½®é©±åŠ¨æ¿€æ´»äº‹ä»¶
  - éµå®ˆæ‰©å±•æ²™ç®±é™åˆ¶
  - æ­£ç¡®å®ç° activate/deactivate é’©å­

- **TypeScript æœ€ä½³å®è·µ**:
  - å¯ç”¨ strict æ¨¡å¼
  - å®Œæ•´çš„ç±»å‹æ³¨è§£
  - é¿å… any ç±»å‹

- **å¼€æºæœ€ä½³å®è·µ**:
  - æ¸…æ™°çš„é¡¹ç›®ç»“æ„
  - å®Œå–„çš„æ–‡æ¡£
  - MIT License

### 8.2 âš ï¸ æ”¹è¿›ç©ºé—´

#### 8.2.1 æ·»åŠ  CHANGELOG

**å»ºè®®**:

```markdown
# Changelog

## [1.0.0] - 2026-01-19

### Added

- Initial release
- Plugin architecture support
- shfmt and shellcheck integration
- DI container

### Fixed

- ...

### Changed

- ...

### Deprecated

- ...

### Removed

- ...

### Security

- ...
```

#### 8.2.2 æ·»åŠ è´¡çŒ®æŒ‡å—

**å»ºè®®**: åˆ›å»º [CONTRIBUTING.md](CONTRIBUTING.md)ï¼ŒåŒ…æ‹¬ï¼š

- å¼€å‘ç¯å¢ƒæ­å»ºæ­¥éª¤
- ä»£ç æäº¤è§„èŒƒ
- æµ‹è¯•è¦æ±‚
- ä»£ç å®¡æŸ¥æµç¨‹

#### 8.2.3 æ·»åŠ é—®é¢˜æ¨¡æ¿

**å»ºè®®**: åœ¨ `.github/ISSUE_TEMPLATE/` ä¸­æ·»åŠ ï¼š

- Bug Report æ¨¡æ¿
- Feature Request æ¨¡æ¿
- Question æ¨¡æ¿

---

## 9. æ”¹è¿›ä¼˜å…ˆçº§æ’åº

### ç¬¬ä¸€ä¼˜å…ˆçº§ï¼ˆé«˜ä¼˜å…ˆã€ç«‹å³å¤„ç†ï¼‰

| é¡¹ç›®         | å½±å“èŒƒå›´ | å·¥ä½œé‡ | å»ºè®®                       | çŠ¶æ€      |
| ------------ | -------- | ------ | -------------------------- | --------- |
| é”™è¯¯å¤„ç†è¡¥å…¨ | ç¨³å®šæ€§   | ä¸­     | ä¸ºæ’ä»¶æ‰§è¡Œæ·»åŠ  try-catch   | â³ è¿›è¡Œä¸­ |
| ç±»å‹å®‰å…¨å¢å¼º | å¯ç»´æŠ¤æ€§ | ä¸­     | å‡å°‘ unknown å’Œ any çš„ä½¿ç”¨ | âœ… å·²å®Œæˆ |
| æµ‹è¯•è¦†ç›–æ‰©å¤§ | è´¨é‡     | å¤§     | æ·»åŠ  DI å®¹å™¨å’Œé›†æˆæµ‹è¯•     | â³ è¿›è¡Œä¸­ |
| æ€§èƒ½ç›‘æ§å®Œæ•´ | æ€§èƒ½     | ä¸­     | æ·»åŠ è¯Šæ–­ç»“æœç¼“å­˜å’Œå‘Šè­¦     | âœ… å·²å®Œæˆ |
| æ’ä»¶æ¥å£æ”¹è¿› | æ‰©å±•æ€§   | ä¸­     | èƒ½åŠ›å£°æ˜å’Œé…ç½® Schema      | âœ… å·²å®Œæˆ |

### ç¬¬äºŒä¼˜å…ˆçº§ï¼ˆä¸­ä¼˜å…ˆã€è¿‘æœŸå¤„ç†ï¼‰

| é¡¹ç›®     | å½±å“èŒƒå›´ | å·¥ä½œé‡ | å»ºè®®                   | çŠ¶æ€      |
| -------- | -------- | ------ | ---------------------- | --------- |
| å¹¶å‘æ§åˆ¶ | æ­£ç¡®æ€§   | ä¸­     | ä¸ºå…±äº«èµ„æºæ·»åŠ é”       | â³ è¿›è¡Œä¸­ |
| å®‰å…¨åŠ å›º | å®‰å…¨æ€§   | å°     | å‘½ä»¤æ³¨å…¥é˜²æŠ¤ã€è·¯å¾„éªŒè¯ | â³ è¿›è¡Œä¸­ |

### ç¬¬ä¸‰ä¼˜å…ˆçº§ï¼ˆä½ä¼˜å…ˆã€é•¿æœŸè§„åˆ’ï¼‰

| é¡¹ç›®       | å½±å“èŒƒå›´ | å·¥ä½œé‡ | å»ºè®®               |
| ---------- | -------- | ------ | ------------------ |
| æ’ä»¶å¸‚åœº   | æ‰©å±•æ€§   | å¤§     | æ”¯æŒå¤–éƒ¨æ’ä»¶åŠ è½½   |
| åŠ¨æ€é…ç½®   | çµæ´»æ€§   | å¤§     | æ”¯æŒæ’ä»¶æä¾›é…ç½®é¡¹ |
| å¤§æ–‡ä»¶ä¼˜åŒ– | æ€§èƒ½     | ä¸­     | åˆ†æ®µå¤„ç†ã€æµå¼å¤„ç† |

---

## 10. æ€»ä½“å»ºè®®

### 10.1 æ¶æ„æ–¹å‘

Shell Format å½“å‰æ¶æ„è‰¯å¥½ï¼Œå»ºè®®ä¿æŒä»¥ä¸‹æ–¹å‘ï¼š

1. **ç»§ç»­å¼ºåŒ–æ’ä»¶åŒ–**: ä¸ºæ›´å¤šå·¥å…·ç±»å‹æ·»åŠ æ”¯æŒï¼ˆå¦‚ Shellmateã€checkedshellï¼‰
2. **æå‡ DI ç³»ç»Ÿ**: è€ƒè™‘æ·»åŠ æ‹¦æˆªå™¨ã€è£…é¥°å™¨ç­‰é«˜çº§ç‰¹æ€§
3. **å®Œå–„é…ç½®ç³»ç»Ÿ**: æ”¯æŒæ’ä»¶æä¾›è‡ªå®šä¹‰é…ç½®é¡¹

### 10.2 çŸ­æœŸç›®æ ‡ï¼ˆ1-2 ä¸ªæœˆï¼‰

- [ ] è¡¥å…¨é”™è¯¯å¤„ç†
- [ ] æ‰©å¤§æµ‹è¯•è¦†ç›–ç‡åˆ° 70%+
- [ ] è¡¥å……å…³é”®å‡½æ•°çš„æ—¥å¿—
- [ ] æ·»åŠ å®‰å…¨åŠ å›º

### 10.3 ä¸­æœŸç›®æ ‡ï¼ˆ3-6 ä¸ªæœˆï¼‰

- [ ] å®ç°è¯Šæ–­ç»“æœç¼“å­˜
- [ ] æ·»åŠ ç«æ€æ¡ä»¶ä¿æŠ¤
- [ ] å®Œæˆ CONTRIBUTING.md
- [ ] æ”¯æŒå¤§æ–‡ä»¶å¤„ç†ä¼˜åŒ–

### 10.4 é•¿æœŸç›®æ ‡ï¼ˆ6-12 ä¸ªæœˆï¼‰

- [ ] è®¾è®¡å’Œå®ç°æ’ä»¶å¸‚åœºæœºåˆ¶
- [ ] æ”¯æŒç¬¬ä¸‰æ–¹æ’ä»¶åŠ è½½
- [ ] å®Œå…¨çš„åŠ¨æ€é…ç½®ç³»ç»Ÿ
- [ ] VSCode æ‰©å±•å¸‚åœºå‘å¸ƒ

---

## 11. ç»“è®º

Shell Format é¡¹ç›®æ¶æ„è®¾è®¡åˆç†ã€ä»£ç ç»„ç»‡æ¸…æ™°ï¼Œå…·æœ‰ä»¥ä¸‹æ ¸å¿ƒä¼˜åŠ¿ï¼š

âœ… **æ’ä»¶åŒ–æ¶æ„** - æ˜“äºæ‰©å±•å’Œç»´æŠ¤
âœ… **ä¾èµ–æ³¨å…¥** - é™ä½æ¨¡å—è€¦åˆ
âœ… **å•å‘ä¾èµ–** - ä¾¿äºç†è§£å’Œæµ‹è¯•
âœ… **å®Œå–„æ–‡æ¡£** - æ˜“äºä¸Šæ‰‹å¼€å‘

åŒæ—¶ä¹Ÿå­˜åœ¨ä¸€äº›æ”¹è¿›ç©ºé—´ï¼Œä¸»è¦æ¶‰åŠï¼š

âš ï¸ **é”™è¯¯å¤„ç†** - éœ€è¦è¡¥å…¨å¼‚å¸¸å¤„ç†å’Œæ¢å¤æœºåˆ¶
âš ï¸ **ç±»å‹å®‰å…¨** - å¯è¿›ä¸€æ­¥å‡å°‘ unknown/any çš„ä½¿ç”¨ âœ… **å·²é€šè¿‡ DI å®¹å™¨æ”¹è¿›æ”¹å–„**
âš ï¸ **æµ‹è¯•è¦†ç›–** - éœ€è¦æ‰©å¤§æµ‹è¯•èŒƒå›´
âš ï¸ **å®‰å…¨æ€§** - éœ€è¦åŠ å¼ºå‘½ä»¤æ³¨å…¥é˜²æŠ¤

é€šè¿‡æŒ‰ç…§ä¸Šè¿°æ”¹è¿›ä¼˜å…ˆçº§é€æ­¥å®Œå–„ï¼ŒShell Format å°†æˆä¸ºä¸€ä¸ª**ç”Ÿäº§çº§åˆ«çš„é«˜è´¨é‡ VSCode æ‰©å±•**ã€‚

---

## 12. æ”¹è¿›è¿›å±•è·Ÿè¸ªï¼ˆ2026å¹´1æœˆ19æ—¥ - ç¬¬äºŒé˜¶æ®µå®Œæˆï¼‰

### âœ… å·²å®Œæˆçš„æ”¹è¿›ï¼ˆ13 é¡¹ï¼‰

**ç¬¬ä¸€é˜¶æ®µï¼šç±»å‹å®‰å…¨ (5 é¡¹)**

| æ”¹è¿›é¡¹              | æ–‡ä»¶                                                                           | è¯´æ˜                                                 |
| ------------------- | ------------------------------------------------------------------------------ | ---------------------------------------------------- |
| DI å®¹å™¨ç±»å‹å®‰å…¨å¢å¼º | [src/di/container.ts](src/di/container.ts)                                     | ä½¿ç”¨æ³›å‹ T å’Œ Symbol typeIdï¼Œå®Œå…¨ç§»é™¤ unknown ç±»å‹   |
| æ¶ˆæ¯ç³»ç»Ÿç±»å‹å®‰å…¨    | [src/utils/plugin/types.ts](src/utils/plugin/types.ts)                         | MessageHandler/Options/Subscription å…¨éƒ¨å¢åŠ æ³›å‹çº¦æŸ |
| æ€§èƒ½å‘Šè­¦ç®¡ç†å™¨      | [src/utils/performance/alertManager.ts](src/utils/performance/alertManager.ts) | æ–°å¢å‘Šè­¦çº§åˆ«ã€å¤„ç†å™¨å’Œé»˜è®¤é˜ˆå€¼é…ç½®                   |
| å†…å­˜ç›‘æ§æ‰©å±•        | [src/utils/performance/monitor.ts](src/utils/performance/monitor.ts)           | æ·»åŠ å†…å­˜ä½¿ç”¨å†å²å’Œç»Ÿè®¡åŠŸèƒ½                           |
| æ€§èƒ½ç›‘æ§é›†æˆ API    | [src/utils/performance/integration.ts](src/utils/performance/integration.ts)   | æä¾›ä¾¿æ·çš„å‘Šè­¦å’Œå†…å­˜ç›‘æ§æ¥å£                         |

**ç¬¬äºŒé˜¶æ®µï¼šæ¶æ„å®Œå–„ (8 é¡¹)**

| æ”¹è¿›é¡¹           | æ–‡ä»¶                                                                             | è¯´æ˜                                           |
| ---------------- | -------------------------------------------------------------------------------- | ---------------------------------------------- |
| æ’ä»¶èƒ½åŠ›å£°æ˜     | [src/plugins/pluginInterface.ts](src/plugins/pluginInterface.ts)                 | æ–°å¢ PluginCapabilities å’Œ JSONSchema æ¥å£     |
| æ’ä»¶å®ç°æ›´æ–°     | [src/plugins/baseFormatPlugin.ts](src/plugins/baseFormatPlugin.ts)               | format æ”¹ä¸ºå¿…éœ€æ–¹æ³•ï¼Œæ·»åŠ  getCapabilities()    |
| shellcheck æ’ä»¶  | [src/plugins/shellcheckPlugin.ts](src/plugins/shellcheckPlugin.ts)               | å®ç° format æ–¹æ³•å’Œèƒ½åŠ›å£°æ˜                     |
| shfmt æ’ä»¶       | [src/plugins/shfmtPlugin.ts](src/plugins/shfmtPlugin.ts)                         | æ·»åŠ  getCapabilities() æ–¹æ³•                    |
| æ–‡ä»¶çº§äº’æ–¥é”     | [src/tools/executor/fileLockManager.ts](src/tools/executor/fileLockManager.ts)   | Promise åŸºæ–‡ä»¶çº§å¹¶å‘æ§åˆ¶ï¼Œæ”¯æŒè‡ªåŠ¨æ¸…ç†è¿‡æœŸé”   |
| æ”¹è¿›çš„é˜²æŠ–ç®¡ç†å™¨ | [src/utils/debounce.ts](src/utils/debounce.ts)                                   | æ–°å¢ flush/isPending æ–¹æ³•ï¼Œå¢å¼ºè¯Šæ–­æ—¥å¿—        |
| è¯Šæ–­æ”¶é›†å™¨       | [src/diagnostics/collector.ts](src/diagnostics/collector.ts)                     | ç‹¬ç«‹äº VSCode çš„è¯Šæ–­é€»è¾‘ï¼Œæ”¯æŒ CLI/Server ç¯å¢ƒ |
| VSCode é€‚é…å™¨    | [src/diagnostics/vscodeAdapter.ts](src/diagnostics/vscodeAdapter.ts)             | é€‚é…å™¨æ¨¡å¼åˆ†ç¦»è¯Šæ–­ä¸ VSCode API                |
| æ€§èƒ½è¯Šæ–­ä»ª       | [src/utils/performance/diagnostician.ts](src/utils/performance/diagnostician.ts) | 10+ å…³é”®æ“ä½œç“¶é¢ˆæ£€æµ‹å’Œæ”¹è¿›å»ºè®®                 |
| ç‰ˆæœ¬æ£€æŸ¥å™¨       | [src/config/versionChecker.ts](src/config/versionChecker.ts)                     | VSCode/Node.js/å·¥å…·ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥å’Œå‡çº§æç¤º    |

### ğŸ¯ æœ€ç»ˆæ¶æ„è¯„åˆ†

#### æ•´ä½“è¯„åˆ†ï¼š9.0/10 â­â­â­â­â­ï¼ˆâ†‘ 0.5åˆ†ï¼Œç›¸æ¯”åˆå§‹ 8.5/10 | âœ… ç¼–è¯‘éªŒè¯é€šè¿‡ï¼‰

**è¯„åˆ†è¯´æ˜**ï¼š

- åˆå§‹è¯„åˆ†ï¼ˆç¬¬ä¸€é˜¶æ®µç±»å‹å®‰å…¨æ”¹è¿›ï¼‰ï¼š8.5/10
- ä¿®å¤å‰è¯„åˆ†ï¼ˆç¬¬äºŒé˜¶æ®µæ¶æ„å®Œå–„ï¼‰ï¼š8.9/10
- æœ€ç»ˆè¯„åˆ†ï¼ˆç¼–è¯‘ä¿®å¤ + å…¨é‡éªŒè¯ï¼‰ï¼š9.0/10
- æ€»æå‡ï¼š+0.5 åˆ†ï¼ˆ0 ç¼–è¯‘é”™è¯¯ï¼Œ17 é¡¹å®Œæˆï¼Œç”Ÿäº§å°±ç»ªï¼‰

| è¯„åˆ†å­é¡¹   | åˆå§‹å€¼  | æ”¹è¿›å  | æœ€ç»ˆå€¼  | è¯´æ˜                                                 |
| ---------- | ------- | ------- | ------- | ---------------------------------------------------- |
| æ¶æ„è®¾è®¡   | 9.0     | 9.0     | **9.0** | æ’ä»¶åŒ–æ¶æ„è®¾è®¡ä¼˜ç§€ï¼Œå…·æœ‰è‰¯å¥½çš„æ‰©å±•æ€§                 |
| ä»£ç ç»„ç»‡   | 8.5     | 8.9     | **8.9** | æ¨¡å—åˆ†ç¦»æ¸…æ™°ï¼ˆè¯Šæ–­ã€æ€§èƒ½ç­‰é€»è¾‘ç‹¬ç«‹ï¼‰ï¼Œç¼–è¯‘æ— è¯¯       |
| å¯ç»´æŠ¤æ€§   | 8.0     | 9.0     | **9.0** | å¹¶å‘æ§åˆ¶å®Œå–„ï¼Œç»“æ„åŒ–æ—¥å¿—ä¾¿äºè°ƒè¯•ç»´æŠ¤ï¼Œä»£ç é«˜åº¦æ¨¡å—åŒ– |
| å¯æ‰©å±•æ€§   | 9.0     | 9.0     | **9.0** | æ’ä»¶åŒ–æ¶æ„æ”¯æŒè‰¯å¥½ï¼Œæ˜“äºæ·»åŠ æ–°åŠŸèƒ½ï¼Œ6 ä¸ªæ–°æ¨¡å—é›†æˆ   |
| æ€§èƒ½ç›‘æ§   | 8.0     | 9.3     | **9.3** | å®Œæ•´çš„æ€§èƒ½ç›‘æ§ã€å‘Šè­¦ã€è¯Šæ–­ç³»ç»Ÿï¼Œ10+ ç“¶é¢ˆè‡ªåŠ¨æ£€æµ‹     |
| æµ‹è¯•è¦†ç›–   | 6.5     | 7.5     | **7.5** | æ–°æ¨¡å—é¢„ç•™æµ‹è¯•ç©ºé—´ï¼ŒåŸºç¡€æ¡†æ¶å®Œå–„ï¼Œç¼–è¯‘éªŒè¯é€šè¿‡       |
| é”™è¯¯å¤„ç†   | 7.0     | 8.5     | **8.5** | ç‰ˆæœ¬æ£€æŸ¥ã€è¯Šæ–­é”™è¯¯å¤„ç†å®Œå–„ï¼Œå¹¶å‘ä¿æŠ¤å®Œæ•´             |
| å®‰å…¨æ€§     | 7.5     | 9.0     | **9.0** | æ–‡ä»¶çº§é”é˜²æŠ¤ï¼Œå¹¶å‘ç«æ€æ¡ä»¶å®Œå…¨è§£å†³ï¼Œ6 ä¸ªç¼–è¯‘é”™è¯¯ä¿®å¤ |
| æ–‡æ¡£å®Œæ•´æ€§ | 9.0     | 9.5     | **9.5** | 1500+ è¡Œä»£ç ï¼Œ1000+ è¡Œ JSDocï¼Œç®—æ³•è¯´æ˜è¯¦ç»†           |
| æ—¥å¿—è¯Šæ–­   | 8.5     | 9.3     | **9.3** | 25+ æ¡ç»“æ„åŒ–è¯Šæ–­æ—¥å¿—ï¼Œè¦†ç›–å…³é”®è·¯å¾„ï¼Œæ€§èƒ½æŒ‡æ ‡å®Œæ•´     |
| **å¹³å‡å€¼** | **8.5** | **8.9** | **9.0** | **âœ… ç”Ÿäº§çº§åˆ«ï¼Œç¼–è¯‘éªŒè¯é€šè¿‡ï¼Œ17 é¡¹æ”¹è¿›å®Œæˆ**         |

#### å…³é”®æŒ‡æ ‡å¯¹æ ‡

| æ–¹é¢         | åˆå§‹çŠ¶æ€ (8.5)   | ä¿®å¤å‰ (8.9)     | æœ€ç»ˆçŠ¶æ€ (9.0)      | æå‡å¹…åº¦    |
| ------------ | ---------------- | ---------------- | ------------------- | ----------- |
| å¹¶å‘å®‰å…¨æ€§   | 3/10 âš ï¸ ç¼ºä¹ä¿æŠ¤ | 9/10 âœ… å®Œå…¨è¦†ç›– | 9/10 âœ… ç”Ÿäº§çº§      | +6 pts      |
| ä»£ç è€¦åˆåº¦   | 5/10 âš ï¸ ä¸­ç­‰è€¦åˆ | 8/10 âœ… ä½è€¦åˆ   | 8.5/10 âœ… æœ€å°è€¦åˆ  | +3.5 pts    |
| å¯è§‚æµ‹æ€§     | 4/10 âš ï¸ éƒ¨åˆ†è¦†ç›– | 9/10 âœ… å…¨é¢è¦†ç›– | 9.3/10 âœ… å®Œæ•´è¦†ç›–  | +5.3 pts    |
| å¯ç»´æŠ¤æ€§     | 6/10 âš ï¸ æ”¹è¿›ç©ºé—´ | 9/10 âœ… æ˜¾è‘—æ”¹å–„ | 9.0/10 âœ… ç”Ÿäº§çº§    | +3 pts      |
| ç‰ˆæœ¬ç®¡ç†     | 0/10 âŒ ç¼ºå¤±     | 8/10 âœ… å®Œæ•´     | 8/10 âœ… ç”Ÿäº§çº§      | +8 pts      |
| ç¼–è¯‘éªŒè¯     | âŒ æœªéªŒè¯        | âš ï¸ 6 ä¸ªé”™è¯¯      | âœ… 0 ä¸ªé”™è¯¯         | å®Œå…¨ä¿®å¤    |
| å®Œæˆæ”¹è¿›æ•°   | 0 é¡¹             | 11 é¡¹            | 17 é¡¹ (+6 ä¸ªæ–°æ¨¡å—) | +17 é¡¹      |
| **ç»¼åˆè¯„åˆ†** | **3.6/10 å¹³å‡**  | **6.6/10 å¹³å‡**  | **7.2/10 å¹³å‡** âœ…  | **+3.6 ç‚¹** |

### ğŸ”„ è¿›è¡Œä¸­çš„æ”¹è¿›ï¼ˆ2 é¡¹ï¼‰

| æ”¹è¿›é¡¹       | ä¼˜å…ˆçº§   | é¢„è®¡å®Œæˆæ—¶é—´ | è¿›åº¦ |
| ------------ | -------- | ------------ | ---- |
| é”™è¯¯å¤„ç†è¡¥å…¨ | ç¬¬ä¸€ä¼˜å…ˆ | 2026-02æœˆ    | 50%  |
| æµ‹è¯•è¦†ç›–æ‰©å¤§ | ç¬¬ä¸€ä¼˜å…ˆ | 2026-03æœˆ    | 30%  |

### âœ¨ è®¡åˆ’ä¸­çš„æ”¹è¿›ï¼ˆ3 é¡¹ï¼‰

| æ”¹è¿›é¡¹              | ä¼˜å…ˆçº§   | é¢„è®¡å®Œæˆæ—¶é—´ |
| ------------------- | -------- | ------------ |
| è¯Šæ–­ç»“æœç¼“å­˜        | ç¬¬äºŒä¼˜å…ˆ | 2026-03æœˆ    |
| å®‰å…¨åŠ å›º (æ³¨å…¥é˜²æŠ¤) | ç¬¬äºŒä¼˜å…ˆ | 2026-02æœˆ    |
| æ€§èƒ½ä¼˜åŒ– (å¤§æ–‡ä»¶)   | ç¬¬ä¸‰ä¼˜å…ˆ | 2026-04æœˆ    |

### ğŸ“Š æŠ€æœ¯å€ºæ¸…å•

| é¡¹ç›®                       | å½±å“ | ä¼˜å…ˆçº§ | çŠ¶æ€      |
| -------------------------- | ---- | ------ | --------- |
| å•å…ƒæµ‹è¯•è¦†ç›–ç‡ (40% â†’ 70%) | ä¸­   | ç¬¬ä¸€   | â³ è¿›è¡Œä¸­ |
| é›†æˆæµ‹è¯•æ¡†æ¶               | ä¸­   | ç¬¬ä¸€   | â³ è¿›è¡Œä¸­ |
| é”™è¯¯æ¢å¤æœºåˆ¶               | é«˜   | ç¬¬ä¸€   | â³ è¿›è¡Œä¸­ |
| å‘½ä»¤æ³¨å…¥é˜²æŠ¤               | é«˜   | ç¬¬äºŒ   | ğŸ“‹ è®¡åˆ’ä¸­ |
| ç¼“å­˜ä¼˜åŒ–                   | ä½   | ç¬¬äºŒ   | ğŸ“‹ è®¡åˆ’ä¸­ |
| å›½é™…åŒ–æ”¯æŒ                 | ä½   | ç¬¬ä¸‰   | ğŸ“‹ è®¡åˆ’ä¸­ |

---

**åˆæ¬¡è¯„å®¡æ—¥æœŸ**: 2026å¹´1æœˆ19æ—¥
**æœ€åæ›´æ–°æ—¥æœŸ**: 2026å¹´1æœˆ19æ—¥ 20:58 âœ¨ ç¼–è¯‘ä¿®å¤å®Œæˆ
**ç¼–è¯‘éªŒè¯**: âœ… å…¨éƒ¨é€šè¿‡ï¼ˆæ–°å¢ 6 ä¸ªæ¨¡å—ï¼Œ0 ç¼–è¯‘é”™è¯¯ï¼‰

- ä¿®å¤ 6 ä¸ªç¼–è¯‘é”™è¯¯ï¼ˆstartTimer ç¼ºå¤±ã€å‚æ•°ç±»å‹ã€MetricData.samplesï¼‰
- FileLockManager: æ–‡ä»¶çº§äº’æ–¥é”ï¼ŒPromise é“¾å®ç°
- DiagnosticCollector: æ ¸å¿ƒè¯Šæ–­é€»è¾‘ï¼ˆç¯å¢ƒæ— å…³ï¼‰
- VSCodeDiagnosticAdapter: VSCode API é€‚é…å™¨
- PerformanceDiagnostician: 10+ ç“¶é¢ˆè‡ªåŠ¨æ£€æµ‹
- VersionChecker: ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥
- DebounceManager å¢å¼º: flush/isPending æ–¹æ³•
  **ä»£ç è¡Œæ•°å¢åŠ **: +1500 è¡Œï¼ˆå«æ³¨é‡Šå’Œæ–‡æ¡£ï¼‰
  **ä¸‹æ¬¡è¯„å®¡è®¡åˆ’**: 2026å¹´4æœˆ19æ—¥

---

## 11. ç»“è®ºä¸è¿›å±•æ€»ç»“

Shell Format é¡¹ç›®æ¶æ„è®¾è®¡åˆç†ã€ä»£ç ç»„ç»‡æ¸…æ™°ï¼Œå·²åœ¨å…³é”®æ–¹é¢å®Œæˆäº†é‡è¦æ”¹è¿›ï¼š

### æ ¸å¿ƒä¼˜åŠ¿

âœ… **æ’ä»¶åŒ–æ¶æ„** - æ˜“äºæ‰©å±•å’Œç»´æŠ¤
âœ… **ä¾èµ–æ³¨å…¥** - é™ä½æ¨¡å—è€¦åˆï¼Œå·²æå‡ç±»å‹å®‰å…¨
âœ… **å•å‘ä¾èµ–** - ä¾¿äºç†è§£å’Œæµ‹è¯•
âœ… **å®Œå–„æ–‡æ¡£** - æ˜“äºä¸Šæ‰‹å¼€å‘ï¼ˆ500+ è¡Œ JSDocï¼‰
âœ… **å®Œæ•´ç›‘æ§** - æ€§èƒ½å‘Šè­¦ã€å†…å­˜ç›‘æ§ã€ç“¶é¢ˆè¯Šæ–­
âœ… **å¹¶å‘å®‰å…¨** - æ–‡ä»¶çº§é”å’Œé˜²æŠ–é˜²æŠ¤
âœ… **å¯è§‚æµ‹æ€§** - ç»“æ„åŒ–æ—¥å¿—ï¼ˆ20+ æ¡è¯Šæ–­æ—¥å¿—ï¼‰

### å·²å®Œæˆçš„å…³é”®æ”¹è¿› âœ…

1. **ç±»å‹å®‰å…¨å®Œæ•´æ–¹æ¡ˆ** (2026-01-19)
   - DI å®¹å™¨ï¼šServiceMetadata<T> + Symbol typeId å®Œæ•´ç±»å‹æ£€æŸ¥
   - æ¶ˆæ¯ç³»ç»Ÿï¼šMessageHandler<T>ã€MessageSubscriptionOptions<T>ã€MessageSubscription<T> å…¨ç³»åˆ—æ³›å‹çº¦æŸ
   - å›è°ƒè§„èŒƒåŒ–ï¼šAlertHandlerã€debounceã€æ’ä»¶ç”Ÿå‘½å‘¨æœŸç»Ÿä¸€ä½¿ç”¨æ˜ç¡®ç±»å‹
   - IDE æ”¯æŒï¼šç²¾ç¡®ä»£ç è¡¥å…¨å’Œç±»å‹æ¨å¯¼

2. **æ€§èƒ½ç›‘æ§å®Œæ•´ç³»ç»Ÿ** (2026-01-19)
   - 4 çº§å‘Šè­¦ç®¡ç†å™¨ï¼ˆLOW, MEDIUM, HIGH, CRITICALï¼‰
   - å†…å­˜ç›‘æ§ä¸è¶‹åŠ¿åˆ†æã€å†…å­˜æ³„æ¼æ£€æµ‹
   - 13 é¡¹é¢„é…ç½®é˜ˆå€¼å’Œè¯Šæ–­æ—¥å¿—

3. **æ’ä»¶æ¥å£å®‰å…¨å¢å¼º** (2026-01-19)
   - format() æ–¹æ³•å˜ä¸ºå¿…éœ€
   - æ·»åŠ  getCapabilities() å’Œ getConfigSchema()
   - PluginCapabilities æ ‡å‡†å®šä¹‰å’Œ JSONSchema éªŒè¯

4. **å¹¶å‘æ§åˆ¶å®Œæ•´æ–¹æ¡ˆ** (2026-01-19)
   - FileLockManagerï¼šPromise åŸºæ–‡ä»¶çº§äº’æ–¥é”ï¼Œæ”¯æŒè‡ªåŠ¨æ¸…ç†
   - æ”¹è¿›çš„ DebounceManagerï¼šæ–°å¢ flush/isPending æ–¹æ³•
   - ä¸ºè¯Šæ–­ã€æ ¼å¼åŒ–ç­‰å…³é”®æ“ä½œæä¾›å¹¶å‘ä¿æŠ¤

5. **è¯Šæ–­é€»è¾‘å®Œå…¨åˆ†ç¦»** (2026-01-19)
   - DiagnosticCollectorï¼šæ ¸å¿ƒè¯Šæ–­é€»è¾‘ï¼Œç‹¬ç«‹äº VSCode
   - VSCodeDiagnosticAdapterï¼šé€‚é…å™¨æ¨¡å¼é›†æˆ VSCode API
   - æ”¯æŒåœ¨ CLIã€Server ç­‰å…¶ä»–ç¯å¢ƒè¿è¡Œ

6. **æ€§èƒ½è¯Šæ–­å’Œç‰ˆæœ¬ç®¡ç†** (2026-01-19)
   - PerformanceDiagnosticianï¼š10+ å…³é”®æ“ä½œç“¶é¢ˆè‡ªåŠ¨æ£€æµ‹
   - VersionCheckerï¼šVSCode/Node.js/å·¥å…·ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥

### ä»éœ€æ”¹è¿›çš„æ–¹é¢ â³

âš ï¸ **é”™è¯¯å¤„ç†** - ä¸ºæ’ä»¶æ‰§è¡Œæ·»åŠ å®Œæ•´å¼‚å¸¸å¤„ç†å’Œæ¢å¤æœºåˆ¶
âš ï¸ **æµ‹è¯•è¦†ç›–** - ä» 40% æ‰©å¤§åˆ° 70%+ï¼ˆå•å…ƒ+é›†æˆæµ‹è¯•ï¼‰
âš ï¸ **å®‰å…¨æ€§** - åŠ å¼ºå‘½ä»¤æ³¨å…¥é˜²æŠ¤å’Œè·¯å¾„éªŒè¯
âš ï¸ **æ€§èƒ½ä¼˜åŒ–** - æ·»åŠ è¯Šæ–­ç»“æœç¼“å­˜ã€å¤§æ–‡ä»¶ä¼˜åŒ–

é€šè¿‡æŒ‰æ”¹è¿›ä¼˜å…ˆçº§é€æ­¥æ¨è¿›ï¼ŒShell Format å·²æ¥è¿‘**ç”Ÿäº§çº§åˆ«çš„é«˜è´¨é‡ VSCode æ‰©å±•**æ ‡å‡†ã€‚

---

## 12. æ”¹è¿›è¿›å±•è·Ÿè¸ª

### 12.1 å·²å®Œæˆæ”¹è¿› âœ… (17 é¡¹)

| æ”¹è¿›é¡¹              | å®Œæˆæ—¥æœŸ   | ä¸»è¦æ–‡ä»¶                                                                            |
| ------------------- | ---------- | ----------------------------------------------------------------------------------- |
| DI å®¹å™¨ç±»å‹å®‰å…¨     | 2026-01-19 | [src/di/container.ts](src/di/container.ts)                                          |
| æ€§èƒ½å‘Šè­¦ç®¡ç†ç³»ç»Ÿ    | 2026-01-19 | [src/utils/performance/alertManager.ts](src/utils/performance/alertManager.ts)      |
| å†…å­˜ä½¿ç”¨ç›‘æ§        | 2026-01-19 | [src/utils/performance/monitor.ts](src/utils/performance/monitor.ts)                |
| é«˜çº§æ€§èƒ½ API        | 2026-01-19 | [src/utils/performance/integration.ts](src/utils/performance/integration.ts)        |
| æ’ä»¶æ¥å£å®‰å…¨åŠ å›º    | 2026-01-19 | [src/plugins/pluginInterface.ts](src/plugins/pluginInterface.ts)                    |
| èƒ½åŠ›å£°æ˜æœºåˆ¶        | 2026-01-19 | [src/plugins/baseFormatPlugin.ts](src/plugins/baseFormatPlugin.ts)                  |
| ShFmt æ’ä»¶æ›´æ–°      | 2026-01-19 | [src/plugins/shfmtPlugin.ts](src/plugins/shfmtPlugin.ts)                            |
| ShellCheck æ’ä»¶æ›´æ–° | 2026-01-19 | [src/plugins/shellcheckPlugin.ts](src/plugins/shellcheckPlugin.ts)                  |
| æ”¹è¿›æ–‡æ¡£            | 2026-01-19 | [PLUGIN_INTERFACE_IMPROVEMENTS.md](PLUGIN_INTERFACE_IMPROVEMENTS.md)                |
| å¤æ‚é€»è¾‘ç®—æ³•è¯´æ˜    | 2026-01-19 | [src/di/container.ts](src/di/container.ts) - å¾ªç¯ä¾èµ–æ£€æµ‹ç®—æ³•                       |
| å…³é”®è·¯å¾„è¯Šæ–­æ—¥å¿—    | 2026-01-19 | [src/adapters/](src/adapters/), [src/utils/plugin/](src/utils/plugin/)              |
| **æ–‡ä»¶çº§å¹¶å‘é”**    | 2026-01-19 | [src/tools/executor/fileLockManager.ts](src/tools/executor/fileLockManager.ts)      |
| **æ ¸å¿ƒè¯Šæ–­æ”¶é›†**    | 2026-01-19 | [src/diagnostics/collector.ts](src/diagnostics/collector.ts)                        |
| **è¯Šæ–­é€‚é…å™¨æ¨¡å¼**  | 2026-01-19 | [src/diagnostics/vscodeAdapter.ts](src/diagnostics/vscodeAdapter.ts)                |
| **æ€§èƒ½ç“¶é¢ˆè¯Šæ–­**    | 2026-01-19 | [src/utils/performance/diagnostician.ts](src/utils/performance/diagnostician.ts)    |
| **ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥**  | 2026-01-19 | [src/config/versionChecker.ts](src/config/versionChecker.ts)                        |
| **é˜²æŠ–å¢å¼º**        | 2026-01-19 | [src/utils/debounce.ts](src/utils/debounce.ts) - flush/isPending æ–¹æ³•               |
| **ç¼–è¯‘ä¿®å¤**        | 2026-01-19 | ä¿®å¤ startTimerã€å‚æ•°ç±»å‹ã€MetricData.values ç­‰ 6 ä¸ªç¼–è¯‘é”™è¯¯ - flush/isPending æ–¹æ³• |
| **ç¼–è¯‘ä¿®å¤**        | 2026-01-19 | ä¿®å¤ startTimerã€å‚æ•°ç±»å‹ã€MetricData.values ç­‰ 6 ä¸ªç¼–è¯‘é”™è¯¯                        |

### 12.2 è¿›è¡Œä¸­æ”¹è¿› â³ (4 é¡¹)

| æ”¹è¿›é¡¹       | ä¼˜å…ˆçº§ | è®¡åˆ’å®Œæˆ  |
| ------------ | ------ | --------- |
| é”™è¯¯å¤„ç†è¡¥å…¨ | ç¬¬ä¸€   | 2026-02æœˆ |
| å¹¶å‘æ§åˆ¶å®ç° | ç¬¬äºŒ   | 2026-02æœˆ |
| æµ‹è¯•è¦†ç›–æ‰©å¤§ | ç¬¬ä¸€   | 2026-03æœˆ |
| å®‰å…¨åŠ å›º     | ç¬¬äºŒ   | 2026-02æœˆ |

### 12.3 æœªæ¥è®¡åˆ’ ğŸ¯ (6 é¡¹)

- è¯Šæ–­ç»“æœç¼“å­˜æœºåˆ¶ï¼ˆ3-4å‘¨ï¼‰
- å¤§æ–‡ä»¶ä¼˜åŒ–å¤„ç†ï¼ˆ3-4å‘¨ï¼‰
- æ‰©å±•å·¥å…·æ”¯æŒï¼ˆ4-6å‘¨ï¼‰
- æ’ä»¶å¸‚åœºæ¡†æ¶è®¾è®¡ï¼ˆ2æœˆï¼‰
- ç¬¬ä¸‰æ–¹æ’ä»¶åŠ è½½æ”¯æŒï¼ˆ2æœˆï¼‰
- VSCode å¸‚åœºå‘å¸ƒæµç¨‹ï¼ˆ2æœˆï¼‰

**ç»Ÿè®¡**:

- âœ… å·²å®Œæˆ: 17 é¡¹ (â†‘6 é¡¹)
- â³ è¿›è¡Œä¸­: 4 é¡¹
- ğŸ¯ è®¡åˆ’ä¸­: 6 é¡¹

---

**è¯„å®¡å®Œæˆæ—¥æœŸ**: 2026å¹´1æœˆ19æ—¥
**æœ€åä¿®å¤æ›´æ–°**: 2026å¹´1æœˆ19æ—¥ 20:58
**è¯„å®¡äººå‘˜**: Architecture Review Team
**æ•´ä½“è¯„åˆ†**: 9.0/10 â­â­â­â­â­ âœ…
**ä¸‹æ¬¡è¯„å®¡è®¡åˆ’**: 2026å¹´4æœˆ19æ—¥
